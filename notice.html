<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>출결·학습 알림장 | 미래엔수학</title>

<meta property="og:type" content="website" />
<meta property="og:title" content="미래엔수학 출결·학습 알림장" />
<meta property="og:description" content="등·하원, 학습 내용, 상담 내용을 확인하세요." />
<meta property="og:image" content="https://shee0777.vercel.app/nam-512.png" />
<meta property="og:url" content="https://shee0777.vercel.app/notice.html" />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;margin:0;background:#0b0f14;color:#e6edf3}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .card{background:#111826;border:1px solid #223047;border-radius:14px;padding:16px;margin:12px 0}
    .title{font-size:20px;font-weight:700;margin:0 0 10px}
    .muted{color:#9fb0c0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>.card{flex:1;min-width:260px}
    .btn{background:#2b90ff;border:0;color:#06101a;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    input,textarea{width:100%;box-sizing:border-box;background:#0b1220;border:1px solid #223047;color:#e6edf3;border-radius:10px;padding:10px}
    textarea{min-height:110px;resize:vertical}
    a{color:#8bd0ff}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid #223047;color:#cfe6ff;font-size:12px}
    .hr{height:1px;background:#223047;margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">출결/학습 안내</div>
      <div id="status" class="muted">불러오는 중…</div>
      <div class="hr"></div>
      <div class="muted" style="font-size:13px">
        * 이 페이지는 카카오톡 공유 링크로 접속했을 때 <b>token</b>으로 학생 정보를 불러옵니다.
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div class="title">학생 정보</div>
        <div id="studentInfo" class="muted">-</div>
      </div>
      <div class="card">
        <div class="title">이번 달 출석</div>
        <div id="attInfo" class="muted">-</div>
      </div>
    </div>

    <div class="card">
      <div class="title">안내 문구</div>
      <div id="noticeText" style="white-space:pre-wrap" class="muted">-</div>
    </div>

    <div class="card">
      <div class="title">학부모 소통</div>
      <div class="muted" style="margin-bottom:8px">학부모님 문의/요청 사항을 남겨주세요. (학원에서 확인)</div>
      <textarea id="msg" placeholder="예) 오늘 숙제 범위를 다시 안내 부탁드려요"></textarea>
      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="sendBtn" class="btn" disabled>메시지 보내기</button>
        <span id="sendResult" class="muted"></span>
      </div>
    </div>
  </div>

  <script type="module">
// =========================================================
    // ✅ notice.html 수정본 (중복 제거 완료)
    // =========================================================
    
    // 1. Firebase 설정
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
      authDomain: "namyang-f3a98.firebaseapp.com",
      projectId: "namyang-f3a98",
      storageBucket: "namyang-f3a98.firebasestorage.app",
      messagingSenderId: "641432133626",
      appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
      measurementId: "G-23L6KZERMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    // URL에서 토큰 가져오기
    function getToken(){
      const sp = new URLSearchParams(location.search);
      return sp.get("token");
    }

    // 이번 달 출석 횟수 계산
    function calcThisMonthAttendance(attendanceLog){
      const now = new Date();
      const logs = (attendanceLog || []).map(ts => {
        if(ts && ts.toDate) return ts.toDate();
        if(ts && ts.seconds) return new Date(ts.seconds * 1000);
        return new Date(ts);
      }).filter(d => !isNaN(d));
      return logs.filter(d => d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()).length;
    }

    async function load(){
      const token = getToken();
      
      if(!token){
        $("status").innerText = "잘못된 접근입니다. (토큰 없음)";
        return;
      }

      // 1. 토큰으로 학생ID 찾기
      let studentId = null;
      try {
          // Firestore에서 조회
          const tSnap = await getDoc(doc(db, "noticeTokens", token));
          if(tSnap.exists()) studentId = tSnap.data().studentId;
      } catch(e) {
          console.warn("Firestore 토큰 조회 실패", e);
      }

      // (백업) 로컬 스토리지에서 조회 (같은 기기 테스트용)
      if(!studentId) {
          try {
              const raw = localStorage.getItem("noticeToken:" + token);
              if(raw) studentId = JSON.parse(raw).studentId;
          } catch(e){}
      }

      if(!studentId){
        $("status").innerText = "유효하지 않거나 만료된 링크입니다.";
        return;
      }

      // 2. 학생 정보 불러오기
      $("status").innerText = "학생 정보를 불러오는 중...";
      try {
          const sSnap = await getDoc(doc(db, "students", studentId));
          if(!sSnap.exists()){
            $("status").innerText = "학생 정보가 삭제되었습니다.";
            return;
          }

          const s = sSnap.data();
          
          // 화면 표시
          $("statusArea").style.display = 'none';
          $("contentArea").style.display = 'block';

          $("studentInfo").innerText = `${s.name} 학생`;
          
          const monthCnt = calcThisMonthAttendance(s.attendanceLog || []);
          $("attInfo").innerText = `이번 달 등원 ${monthCnt}회`;

          // 선생님이 보낸 알림장 내용 파싱
          const noticeText = s.lastNotice || "학부모님, 안녕하세요! \n오늘의 학습 내용을 확인해주세요.";
          $("noticeText").innerText = noticeText;

      } catch(e) {
          console.error(e);
          $("status").innerText = "오류가 발생했습니다.";
      }

      // 메시지 보내기 버튼
      $("sendBtn").onclick = async () => {
        const msg = $("msg").value.trim();
        if(!msg) return alert("내용을 입력해주세요.");
        
        $("sendBtn").disabled = true;
        $("sendBtn").innerText = "전송 중...";
        
        try{
          await addDoc(collection(db, "parentMessages"), {
            token,
            studentId,
            message: msg,
            createdAt: serverTimestamp(),
            read: false
          });
          alert("선생님께 메시지를 보냈습니다! ✅");
          $("msg").value = "";
          $("sendResult").innerText = "전송 완료되었습니다.";
        }catch(e){
          alert("전송 실패: " + e.message);
        }finally{
          $("sendBtn").disabled = false;
          $("sendBtn").innerText = "메시지 보내기";
        }
      };
    }

    load();
  </script>
</body>
</html>
