<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¶œê²°Â·í•™ìŠµ ì•Œë¦¼ì¥ | ë¯¸ë˜ì—”ìˆ˜í•™</title>

  <meta property="og:type" content="website" />
  <meta property="og:title" content="ë¯¸ë˜ì—”ìˆ˜í•™ ì¶œê²°Â·í•™ìŠµ ì•Œë¦¼ì¥" />
  <meta property="og:description" content="ìë…€ì˜ ë“±Â·í•˜ì›, í•™ìŠµ ë‚´ìš©, ìƒë‹´ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”." />
  <meta property="og:image" content="https://shee0777.vercel.app/nam-512.png" />
  <meta property="og:url" content="https://shee0777.vercel.app/notice.html" />

  <style>
    body{font-family:'Pretendard', system-ui, -apple-system, sans-serif; margin:0; background:#f8fafc; color:#0f172a;}
    .wrap{max-width:600px; margin:0 auto; padding:20px;}
    
    .card{
        background:#ffffff; 
        border:1px solid #e2e8f0; 
        border-radius:20px; 
        padding:20px; 
        margin-bottom:16px; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    .title{font-size:18px; font-weight:800; margin-bottom:12px; color:#1e293b; display:flex; align-items:center; gap:8px;}
    .muted{color:#64748b; font-size:15px; line-height:1.5;}
    
    .row{display:flex; gap:12px;}
    .row > .card { flex:1; text-align:center; }
    
    .badge-wrap{ text-align:center; margin-bottom:20px; }
    .badge{ 
        display:inline-block; padding:6px 14px; 
        border-radius:999px; background:#eff6ff; 
        color:#3b82f6; font-size:13px; font-weight:700; 
    }

    textarea{
        width:100%; box-sizing:border-box; 
        background:#f8fafc; border:1px solid #cbd5e1; 
        border-radius:12px; padding:14px; 
        font-size:15px; min-height:100px; resize:vertical;
        margin-bottom:10px;
    }
    textarea:focus{ outline:none; border-color:#3b82f6; background:#fff; }

    .btn{
        width:100%;
        background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
        border:0; color:white; 
        padding:16px; border-radius:16px; 
        font-size:16px; font-weight:700; cursor:pointer;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; }
    
    #noticeText {
        background: #fffbeb;
        border: 1px solid #fcd34d;
        padding: 16px;
        border-radius: 12px;
        color: #451a03;
    }
  </style>
</head>
<body>
  <div class="wrap">
    
    <div id="statusArea" style="text-align:center; margin:40px 0;">
        <div id="status" style="font-size:18px; font-weight:bold; color:#64748b;">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div id="contentArea" style="display:none;">
        <div class="card" style="text-align:center; padding:30px 20px;">
             <img src="nam-192.png" style="width:60px; height:60px; border-radius:18px; margin-bottom:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
             <h2 id="studentInfo" style="margin:0; font-size:24px; color:#0f172a;">-</h2>
             <p id="attInfo" style="margin:5px 0 0 0; color:#3b82f6; font-weight:bold;">ì´ë²ˆ ë‹¬ ë“±ì› 0íšŒ</p>
        </div>

        <div class="card">
            <div class="title">ğŸ“¢ ì˜¤ëŠ˜ì˜ ì•Œë¦¼ì¥</div>
            <div id="noticeText" style="white-space:pre-wrap;">(ë“±ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤)</div>
        </div>

        <div class="card">
            <div class="title">ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</div>
            <div class="muted" style="margin-bottom:10px; font-size:14px;">ê¶ê¸ˆí•˜ì‹  ì ì´ë‚˜ ìš”ì²­ì‚¬í•­ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</div>
            <textarea id="msg" placeholder="ì˜ˆ) ì„ ìƒë‹˜, ë‹¤ìŒ ì£¼ ì›”ìš”ì¼ì€ ê°€ì¡± ì—¬í–‰ìœ¼ë¡œ ê²°ì„í•©ë‹ˆë‹¤."></textarea>
            <button id="sendBtn" class="btn">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
            <div id="sendResult" style="text-align:center; margin-top:10px; font-weight:bold;"></div>
        </div>
    </div>
  </div>

  <script type="module">
    // 1. Firebase ì„¤ì • (index.htmlê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
      authDomain: "namyang-f3a98.firebaseapp.com",
      projectId: "namyang-f3a98",
      storageBucket: "namyang-f3a98.firebasestorage.app",
      messagingSenderId: "641432133626",
      appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
      measurementId: "G-23L6KZERMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    // URLì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
    function getToken(){
      const sp = new URLSearchParams(location.search);
      return sp.get("token");
    }

    // ì´ë²ˆ ë‹¬ ì¶œì„ íšŸìˆ˜ ê³„ì‚°
    function calcThisMonthAttendance(attendanceLog){
      const now = new Date();
      const logs = (attendanceLog || []).map(ts => {
        if(ts && ts.toDate) return ts.toDate();
        if(ts && ts.seconds) return new Date(ts.seconds * 1000);
        return new Date(ts);
      }).filter(d => !isNaN(d));
      return logs.filter(d => d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()).length;
    }

    async function load(){
      const token = getToken();
      
      if(!token){
        $("status").innerText = "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (í† í° ì—†ìŒ)";
        return;
      }

      // 1. í† í°ìœ¼ë¡œ í•™ìƒID ì°¾ê¸°
      let studentId = null;
      try {
          // Firestoreì—ì„œ ì¡°íšŒ
          const tSnap = await getDoc(doc(db, "noticeTokens", token));
          if(tSnap.exists()) studentId = tSnap.data().studentId;
      } catch(e) {
          console.warn("Firestore í† í° ì¡°íšŒ ì‹¤íŒ¨", e);
      }

      // (ë°±ì—…) ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¡°íšŒ (ê°™ì€ ê¸°ê¸° í…ŒìŠ¤íŠ¸ìš©)
      if(!studentId) {
          try {
              const raw = localStorage.getItem("noticeToken:" + token);
              if(raw) studentId = JSON.parse(raw).studentId;
          } catch(e){}
      }

      if(!studentId){
        $("status").innerText = "ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ë§í¬ì…ë‹ˆë‹¤.";
        return;
      }

      // 2. í•™ìƒ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
      $("status").innerText = "í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      try {
          const sSnap = await getDoc(doc(db, "students", studentId));
          if(!sSnap.exists()){
            $("status").innerText = "í•™ìƒ ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
            return;
          }

          const s = sSnap.data();
          
          // í™”ë©´ í‘œì‹œ
          $("statusArea").style.display = 'none';
          $("contentArea").style.display = 'block';

          $("studentInfo").innerText = `${s.name} í•™ìƒ`;
          
          const monthCnt = calcThisMonthAttendance(s.attendanceLog || []);
          $("attInfo").innerText = `ì´ë²ˆ ë‹¬ ë“±ì› ${monthCnt}íšŒ`;

          // ì„ ìƒë‹˜ì´ ë³´ë‚¸ ì•Œë¦¼ì¥ ë‚´ìš© íŒŒì‹± (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
          // 1. ë°©ê¸ˆ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë‚˜ URL íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê¸¸ ìˆ˜ë„ ìˆì§€ë§Œ,
          //    í˜„ì¬ êµ¬ì¡°ì—ì„œëŠ” 'ë§ˆì§€ë§‰ ì•Œë¦¼'ì„ DBì— ì €ì¥í•˜ê±°ë‚˜ í•´ì•¼ í•©ë‹ˆë‹¤.
          //    ì¼ë‹¨ ì§€ê¸ˆì€ ì´ì „ì— ì €ì¥ëœ noticeText í•„ë“œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
          //    (ì£¼ì˜: ì¹´í†¡ ë³´ë‚¼ ë•Œ DBì— noticeTextë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì´ index.htmlì— ì¶”ê°€ë˜ì–´ì•¼ ì™„ë²½í•©ë‹ˆë‹¤.)
          //    ì§€ê¸ˆì€ ì„ì‹œë¡œ ê¸°ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ê±°ë‚˜, index.htmlì—ì„œ ì•Œë¦¼ì¥ ë³´ë‚¼ ë•Œ DB ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
          
          // [ì¤‘ìš”] ì‚¬ìš©ìê°€ ì¹´í†¡ìœ¼ë¡œ ë³´ë‚¸ í…ìŠ¤íŠ¸ ìì²´ëŠ” DBì— ì €ì¥ì´ ì•ˆ ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          // index.html ìˆ˜ì •ì´ í•„ìš”í•  ìˆ˜ ìˆì§€ë§Œ, ì¼ë‹¨ í™”ë©´ì´ ëœ¨ëŠ”ì§€ë¶€í„° í™•ì¸í•©ë‹ˆë‹¤.
          const noticeText = s.lastNotice || "í•™ë¶€ëª¨ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! \nì˜¤ëŠ˜ì˜ í•™ìŠµ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
          $("noticeText").innerText = noticeText;

      } catch(e) {
          console.error(e);
          $("status").innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }

      // ë©”ì‹œì§€ ë³´ë‚´ê¸° ë²„íŠ¼
      $("sendBtn").onclick = async () => {
        const msg = $("msg").value.trim();
        if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        $("sendBtn").disabled = true;
        $("sendBtn").innerText = "ì „ì†¡ ì¤‘...";
        
        try{
          await addDoc(collection(db, "parentMessages"), {
            token,
            studentId,
            message: msg,
            createdAt: serverTimestamp(),
            read: false
          });
          alert("ì„ ìƒë‹˜ê»˜ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤! âœ…");
          $("msg").value = "";
          $("sendResult").innerText = "ì „ì†¡ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
        }catch(e){
          alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message);
        }finally{
          $("sendBtn").disabled = false;
          $("sendBtn").innerText = "ë©”ì‹œì§€ ë³´ë‚´ê¸°";
        }
      };
    }

    load();
  </script>
</body>
</html>
