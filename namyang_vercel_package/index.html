<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„ êµì‹¤ ê´€ë¦¬</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
/* =========================================================
   2026 Parent-Friendly UI System (Mobile-first)
   - Soft card UI + gentle 3D
   - Bottom navigation on phone
   - Tablet kiosk: big, tappable 3D attendance cards
   ========================================================= */

:root{
  --brand-blue:#3B82F6;
  --brand-blue-700:#1D4ED8;
  --brand-blue-soft:#EFF6FF;

  --brand-yellow:#FACC15;
  --brand-yellow-soft:#FEF9C3;

  --ink:#0F172A;
  --ink-sub:#475569;

  --bg:#F8FAFC;
  --card:#FFFFFF;

  --line: rgba(15,23,42,.08);
  --shadow: 0 10px 30px rgba(15,23,42,.08);
  --shadow-soft: 0 6px 16px rgba(15,23,42,.08);

  --success:#22C55E;
  --warning:#F59E0B;
  --danger:#EF4444;

  --r-lg: 22px;
  --r-md: 16px;
  --r-sm: 12px;

  --tap: 48px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family:'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: radial-gradient(1200px 600px at 30% -10%, #DBEAFE 0%, rgba(219,234,254,0) 60%),
              radial-gradient(900px 500px at 90% 10%, #FEF9C3 0%, rgba(254,249,195,0) 55%),
              var(--bg);
  color:var(--ink);
  -webkit-font-smoothing:antialiased;
 padding: 14px 12px 160px; 
}

.container{
  max-width: 860px;
  margin: 0 auto;
  background: rgba(255,255,255,.72);
  border: 1px solid rgba(255,255,255,.6);
  backdrop-filter: blur(14px);
  border-radius: calc(var(--r-lg) + 6px);
  box-shadow: var(--shadow);
  padding: 14px;
}

/* ----- Header (Brand) ----- */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 10px 10px 14px;
  border-bottom: 1px solid var(--line);
  margin-bottom: 12px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.brand-mark{
  width: 38px;
  height: 38px;
  border-radius: 14px;
  object-fit: cover;
  box-shadow: 0 8px 20px rgba(59,130,246,.18);
  background: #fff;
  border: 1px solid rgba(15,23,42,.06);
}
.brand-title{
  display:flex;
  flex-direction:column;
  min-width:0;
}
.brand-title strong{
  font-size: 16px;
  font-weight: 900;
  letter-spacing: -0.2px;
  line-height: 1.1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.brand-title span{
  font-size: 12px;
  color: var(--ink-sub);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.admin-switch{
  display:flex;
  align-items:center;
  gap:10px;
  padding: 8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.65);
  border: 1px solid rgba(15,23,42,.06);
  box-shadow: 0 6px 16px rgba(15,23,42,.06);
  font-size: 12px;
  color: var(--ink-sub);
}
.admin-switch input{ transform: translateY(1px); }
#btnKioskStart{
  display:none;
  border:none;
  border-radius: 999px;
  padding: 10px 12px;
  font-weight: 800;
  color:#0F172A;
  background: linear-gradient(180deg, #FEF9C3 0%, #FDE68A 100%);
  box-shadow: 0 8px 18px rgba(250,204,21,.25);
  cursor:pointer;
}

/* ----- Pages / Tabs ----- */
.page{ display:none; animation: fadeIn .2s ease; }
.page.active{ display:block; }
@keyframes fadeIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

/* Bottom Navigation (re-using existing .tabs markup) */
.tabs{
  position: fixed;
  left: 12px;
  right: 12px;
  bottom: 12px;
  z-index: 50;

  display:flex;
  gap: 8px;
  padding: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.78);
  border: 1px solid rgba(15,23,42,.08);
  backdrop-filter: blur(16px);
  box-shadow: 0 18px 40px rgba(15,23,42,.12);
}
.tab-btn{
  flex:1;
  min-height: var(--tap);
  border:none;
  border-radius: 999px;
  background: transparent;
  cursor:pointer;

  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;

  font-size: 13px;
  font-weight: 800;
  color: var(--ink-sub);
  transition: transform .12s ease, background .12s ease, color .12s ease;
}
.tab-btn i{ font-size: 16px; }
.tab-btn.active{
  background: linear-gradient(180deg, rgba(59,130,246,.18) 0%, rgba(59,130,246,.10) 100%);
  color: var(--brand-blue-700);
}
.tab-btn:active{ transform: scale(.98); }

/* On wider screens, make tabs inline (not fixed) */
@media (min-width: 900px){
  body{ padding-bottom: 14px; }
  .tabs{
    position: static;
    margin: 8px 0 14px;
    border-radius: 18px;
    box-shadow: 0 10px 26px rgba(15,23,42,.10);
  }
}

/* ----- Forms ----- */
.form-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.full-width{ grid-column: 1 / -1; }

label{
  display:block;
  font-size: 12px;
  font-weight: 800;
  color: var(--ink-sub);
  margin: 0 0 6px;
}
input, select, textarea{
  width:100%;
  min-height: var(--tap);
  padding: 12px 12px;
  border-radius: var(--r-md);
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.85);
  color: var(--ink);
  outline: none;
  font-size: 14px;
  transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
}
textarea{ min-height: 110px; resize: vertical; }
input:focus, select:focus, textarea:focus{
  border-color: rgba(59,130,246,.55);
  box-shadow: 0 0 0 4px rgba(59,130,246,.14);
  background: #fff;
}
input::placeholder, textarea::placeholder{ color: rgba(71,85,105,.7); }

button{ min-height: var(--tap); }

button.action-btn{
  width:100%;
  border:none;
  border-radius: 18px;
  padding: 14px 14px;
  font-weight: 900;
  font-size: 15px;
  cursor:pointer;
  color: white;
  background: linear-gradient(180deg, var(--brand-blue) 0%, var(--brand-blue-700) 100%);
  box-shadow: 0 12px 28px rgba(59,130,246,.24);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
}
button.action-btn:hover{ filter: brightness(1.02); }
button.action-btn:active{ transform: translateY(1px) scale(.995); box-shadow: 0 8px 22px rgba(59,130,246,.20); }
button.action-btn:disabled{
  opacity:.55;
  cursor:not-allowed;
  box-shadow:none;
}

/* ----- Filter Chips ----- */
.filter-container{
  border-radius: var(--r-lg);
  background: rgba(255,255,255,.75);
  border: 1px solid rgba(15,23,42,.08);
  box-shadow: var(--shadow-soft);
  padding: 12px;
  margin-bottom: 12px;
}
.filter-row{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
.filter-label{
  font-size:12px;
  font-weight:900;
  color: var(--ink-sub);
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(59,130,246,.10);
}
.filter-group{ display:flex; gap:6px; flex-wrap: wrap; flex: 1; }

.filter-chip{
  padding: 9px 12px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.85);
  font-size: 13px;
  font-weight: 800;
  color: var(--ink-sub);
  cursor:pointer;
  transition: transform .12s ease, background .12s ease, color .12s ease;
}
.filter-chip.active{
  background: linear-gradient(180deg, rgba(250,204,21,.35) 0%, rgba(250,204,21,.18) 100%);
  border-color: rgba(250,204,21,.55);
  color: #7C5A00;
}

/* ----- Student Cards (Parent-friendly) ----- */
#studentListArea{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  padding: 4px;
}
.student-card{
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.08);
  border-radius: 20px;
  padding: 14px 12px;
  box-shadow: 0 10px 22px rgba(15,23,42,.08);
  cursor: pointer;
  position: relative;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  height: 170px;

  display:flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align:center;
}
.student-card:hover{
  transform: translateY(-2px);
  border-color: rgba(59,130,246,.25);
  box-shadow: 0 16px 30px rgba(15,23,42,.10);
}
.student-card:active{ transform: scale(.985); }

.chk-wrapper{ position:absolute; top:10px; left:10px; }
.list-chk{ width:20px; height:20px; accent-color: var(--brand-blue); }

.profile-wrapper{ width: 64px; height: 64px; margin-bottom: 8px; }
.profile-img{
  width:100%; height:100%;
  border-radius: 22px;
  object-fit: cover;
  background:#eee;
  border: 1px solid rgba(15,23,42,.06);
  box-shadow: 0 10px 20px rgba(15,23,42,.12);
}
.info-area{ width:100%; }
.info-area div:first-child{
  font-size: 15px;
  font-weight: 900;
  letter-spacing: -0.2px;
}
.info-area small{
  display:block;
  font-size: 12px;
  color: var(--ink-sub);
  margin-top: 2px;
  overflow:hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.grade-tag{
  display:inline-block;
  margin-left: 6px;
  padding: 3px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 900;
  color: #0F172A;
  background: rgba(59,130,246,.12);
  border: 1px solid rgba(59,130,246,.18);
}

/* ----- Modal (Glass) ----- */
.modal-overlay{
  display:none;
  position: fixed;
  inset:0;
  background: rgba(2,6,23,.52);
  backdrop-filter: blur(6px);
  z-index: 100;
  justify-content:center;
  align-items:center;
  padding: 18px;
}
.modal{
  width: min(560px, 92vw);
  max-height: 90vh;
  overflow:auto;
  border-radius: 26px;
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(255,255,255,.55);
  box-shadow: 0 26px 70px rgba(2,6,23,.35);
  padding: 18px;
  position: relative;
}
.close-btn{
  position:absolute;
  right: 14px; top: 14px;
  width: 42px; height: 42px;
  border-radius: 999px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.75);
  cursor:pointer;
  font-size: 22px;
  color: var(--ink-sub);
}
.modal-header-profile{
  text-align:center;
  padding-bottom: 12px;
  margin-bottom: 12px;
  border-bottom: 1px solid rgba(15,23,42,.08);
}
.modal-tab-nav{
  display:flex;
  gap: 8px;
  padding: 8px;
  border-radius: 18px;
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.10);
  margin: 10px 0 12px;
}
.modal-tab-btn{
  flex:1;
  border:none;
  border-radius: 14px;
  background: transparent;
  padding: 12px 10px;
  font-weight: 900;
  color: var(--ink-sub);
  cursor:pointer;
}
.modal-tab-btn.active{
  background: rgba(255,255,255,.85);
  color: var(--brand-blue-700);
  box-shadow: 0 10px 18px rgba(15,23,42,.08);
}
.modal-tab-pane{ display:none; }
.modal-tab-pane.active{ display:block; }

.stat-box{
  display:flex;
  gap: 10px;
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.12);
  border-radius: 18px;
  padding: 12px;
}
.stat-num{ font-size: 20px; font-weight: 950; color: var(--brand-blue-700); }

/* Contact buttons (keep existing classes) */
.contact-row{ display:flex; justify-content:center; align-items:center; gap: 14px; flex-wrap: wrap; }
.contact-btn{
  width: 38px; height: 38px;
  border-radius: 999px;
  display:flex; align-items:center; justify-content:center;
  border: 1px solid rgba(15,23,42,.08);
  box-shadow: 0 10px 18px rgba(15,23,42,.10);
}
.btn-call{ background: rgba(34,197,94,.12); color: #166534; }
.btn-sms{ background: rgba(59,130,246,.12); color: #1D4ED8; }
.btn-kakao{ background: rgba(250,204,21,.25); color: #3c1e1e; }

/* ----- Toast (cute) ----- */
.toast{
  position: fixed;
  left:50%;
  bottom: calc(120px + env(safe-area-inset-bottom));
  transform: translateX(-50%) translateY(10px);
  opacity: 0;
  pointer-events:none;
  z-index: 9999;
  max-width: calc(100vw - 24px);

  display:flex;
  align-items:center;
  gap:10px;

  background: rgba(255,255,255,.88);
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: 0 18px 40px rgba(2,6,23,.20);
  border-radius: 999px;
  padding: 12px 14px;
  color: var(--ink);
  font-weight: 800;
}
.toast.show{ opacity:1; transform: translateX(-50%) translateY(0); transition: opacity .16s ease, transform .16s ease; }
.toast .dot{ width:10px; height:10px; border-radius:999px; background: var(--success); }
.toast.error .dot{ background: var(--danger); }
.toast.warn .dot{ background: var(--warning); }

/* =========================================================
   Tablet Kiosk Mode (Attendance)
   - Big 3D cards
   - Minimal distractions
   ========================================================= */

body.kiosk-mode{
  padding: 0;
  background: radial-gradient(1100px 600px at 20% -10%, #DBEAFE 0%, rgba(219,234,254,0) 60%),
              radial-gradient(900px 500px at 95% 0%, #FEF9C3 0%, rgba(254,249,195,0) 55%),
              linear-gradient(180deg, #F8FAFC 0%, #EEF2FF 100%);
}

body.kiosk-mode .container{
  max-width: 100%;
  background: transparent;
  border: none;
  box-shadow: none;
  border-radius: 0;
  padding: 12px;
}

body.kiosk-mode header,
body.kiosk-mode .tabs,
body.kiosk-mode .filter-container,
body.kiosk-mode .admin-toolbar,
body.kiosk-mode .admin-only,
body.kiosk-mode #register,
body.kiosk-mode #calendar{
  display:none !important;
}
body.kiosk-mode #list{ display:block !important; }
body.kiosk-mode #studentListArea{
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 18px;
  padding: 8px;
}

/* Kiosk header category chips */
.kiosk-header{
  display:none;
  position: sticky;
  top: 0;
  z-index: 200;
  padding: 12px 10px;
  margin: 0 0 12px;
  border-radius: 22px;
  background: rgba(255,255,255,.82);
  border: 1px solid rgba(15,23,42,.08);
  backdrop-filter: blur(16px);
  box-shadow: 0 16px 40px rgba(15,23,42,.10);
  justify-content:center;
  gap: 8px;
  flex-wrap: wrap;
}
body.kiosk-mode .kiosk-header{ display:flex; }

.k-filter-btn{
  border:none;
  border-radius: 999px;
  padding: 12px 18px;
  font-size: 15px;
  font-weight: 950;
  cursor:pointer;
  color: var(--ink-sub);
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.12);
  transition: transform .12s ease, background .12s ease;
}
.k-filter-btn.active{
  background: linear-gradient(180deg, rgba(250,204,21,.55) 0%, rgba(250,204,21,.28) 100%);
  border-color: rgba(250,204,21,.60);
  color: #7C5A00;
  transform: scale(1.03);
}

/* Kiosk Exit button */
.kiosk-exit-btn{
  position: fixed;
  right: 18px;
  top: 18px;
  width: 56px;
  height: 56px;
  border-radius: 999px;
  display:none;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index: 99999;

  background: rgba(255,255,255,.72);
  border: 1px solid rgba(15,23,42,.10);
  box-shadow: 0 18px 40px rgba(2,6,23,.18);
  color: var(--brand-blue-700);
}
body.kiosk-mode .kiosk-exit-btn{ display:flex; }

/* Kiosk 3D cards (tap = attendance) */
body.kiosk-mode .student-card{
  height: 360px;
  padding: 18px 16px;
  border-radius: 28px;
  background: linear-gradient(180deg, rgba(255,255,255,.96) 0%, rgba(255,255,255,.82) 100%);
  border: 1px solid rgba(15,23,42,.10);

  box-shadow:
    0 16px 0 rgba(148,163,184,.35),
    0 28px 45px rgba(15,23,42,.18);
}
body.kiosk-mode .student-card:active{
  transform: translateY(10px);
  box-shadow:
    0 6px 0 rgba(148,163,184,.35),
    0 18px 32px rgba(15,23,42,.14);
}

/* Arrived state (soft green) */
body.kiosk-mode .student-card.arrived{
  background: linear-gradient(180deg, rgba(34,197,94,.18) 0%, rgba(255,255,255,.86) 70%);
  border-color: rgba(34,197,94,.25);
}

/* ----- Kiosk status (ë©€ë¦¬ì„œë„ êµ¬ë¶„) ----- */
.kiosk-pill{
  position:absolute;
  top: 14px;
  right: 14px;
  padding: 8px 12px;
  border-radius: 999px;
  font-weight: 950;
  font-size: 14px;
  letter-spacing: -0.2px;
  border: 1px solid rgba(15,23,42,.10);
  background: rgba(255,255,255,.85);
  box-shadow: 0 10px 20px rgba(15,23,42,.10);
}
.kiosk-pill.missing{ background: rgba(148,163,184,.22); border-color: rgba(148,163,184,.32); color:#334155; }
.kiosk-pill.arrived{ background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.32); color:#14532d; }
.kiosk-pill.left{ background: rgba(100,116,139,.18); border-color: rgba(100,116,139,.28); color:#334155; }

.kiosk-hint{
  margin-top: 10px;
  width:100%;
  padding: 10px 12px;
  border-radius: 18px;
  font-weight: 900;
  font-size: 14px;
  color: var(--ink-sub);
  background: rgba(59,130,246,.08);
  border: 1px solid rgba(59,130,246,.10);
}
.kiosk-hint strong{ color: var(--brand-blue-700); }

body.kiosk-mode .student-card.missing{
  background: linear-gradient(180deg, rgba(148,163,184,.18) 0%, rgba(255,255,255,.86) 70%);
  border-color: rgba(148,163,184,.30);
  filter: saturate(.92);
}
body.kiosk-mode .student-card.left{
  background: linear-gradient(180deg, rgba(100,116,139,.14) 0%, rgba(255,255,255,.82) 75%);
  border-color: rgba(100,116,139,.26);
  opacity: .72;
  filter: grayscale(.22);
}
body.kiosk-mode .student-card.left .profile-img{ filter: grayscale(.35); opacity:.9; }

/* Bigger profile + name */
body.kiosk-mode .profile-wrapper{ width: 150px; height: 150px; margin-bottom: 14px; }
body.kiosk-mode .profile-img{ border-radius: 28px; }
body.kiosk-mode .info-area div:first-child{ font-size: 28px; }
body.kiosk-mode .info-area small{ font-size: 14px; }

/* Keep existing kiosk buttons if your JS injects them */
body.kiosk-mode .kiosk-btn-group{
  display:flex;
  gap: 10px;
  width:100%;
  margin-top: auto;
}
.k-btn{
  flex:1;
  border:none;
  border-radius: 18px;
  padding: 14px 0;
  font-size: 16px;
  font-weight: 950;
  cursor:pointer;
  box-shadow: 0 14px 26px rgba(2,6,23,.10);
}
.k-btn-in{ background: linear-gradient(180deg, rgba(250,204,21,.80) 0%, rgba(250,204,21,.55) 100%); color:#7C5A00; }
.k-btn-out{ background: rgba(59,130,246,.12); color: var(--brand-blue-700); border: 1px solid rgba(59,130,246,.18); }

.k-btn:disabled{
  opacity:.55;
  cursor:not-allowed;
  box-shadow:none;
}

/* Small tweaks */
.dept-badge{ border-radius: 999px; padding: 3px 8px; font-weight: 900; }


/* ===== Calendar (restored & modernized) ===== */
#calendar .calendar-controls{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  padding: 12px;
  border-radius: var(--r-lg);
  background: rgba(255,255,255,.78);
  border: 1px solid rgba(15,23,42,.08);
  box-shadow: var(--shadow-soft);
  margin-bottom: 12px;
}
#calendar .cal-btn{
  min-height: var(--tap);
  padding: 10px 12px;
  border:none;
  border-radius: 16px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(59,130,246,.10);
  color: var(--brand-blue-700);
}
#calendar .current-date{
  font-size: 18px;
  font-weight: 950;
  letter-spacing: -0.3px;
  color: var(--ink);
}

.calendar-grid{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}
.day-name{
  text-align:center;
  font-weight: 950;
  font-size: 12px;
  color: var(--ink-sub);
  padding: 6px 0;
}
.day-cell{
  border-radius: 16px;
  border: 1px solid rgba(15,23,42,.08);
  background: rgba(255,255,255,.86);
  box-shadow: 0 8px 18px rgba(15,23,42,.06);
  min-height: 54px;
  padding: 6px 6px 10px;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  transition: transform .12s ease, box-shadow .12s ease;
}
.day-cell:hover{
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(15,23,42,.08);
}
.day-num{
  font-size: 12px;
  font-weight: 950;
  color: var(--ink);
}
.day-cell.selected{
  outline: 4px solid rgba(59,130,246,.18);
  border-color: rgba(59,130,246,.35);
}
.event-dot{
  width: 7px; height: 7px;
  border-radius: 999px;
  margin-top: 4px;
}
.dot-schedule{ background: rgba(59,130,246,.90); }
.dot-birthday{ background: rgba(250,204,21,.95); }

#dateDetailArea{
  margin-top: 12px;
  border-radius: var(--r-lg);
  background: rgba(255,255,255,.78);
  border: 1px solid rgba(15,23,42,.08);
  box-shadow: var(--shadow-soft);
  padding: 12px;
}
.view-mode-group{
  display:flex;
  gap: 8px;
  justify-content:center;
  flex-wrap: wrap;
  margin-bottom: 10px;
}
.view-mode-btn{
  border:none;
  border-radius: 999px;
  padding: 10px 14px;
  font-weight: 950;
  cursor:pointer;
  background: rgba(59,130,246,.08);
  color: var(--ink-sub);
}
.view-mode-btn.active{
  background: linear-gradient(180deg, rgba(250,204,21,.55) 0%, rgba(250,204,21,.26) 100%);
  color: #7C5A00;
  border: 1px solid rgba(250,204,21,.55);
}

/* ===== Admin selection layout fixes (ì›ìƒê´€ë¦¬) ===== */
body.show-admin #studentListArea{
  grid-template-columns: 1fr !important;
}
body.show-admin .student-card{
  height: auto !important;
  flex-direction: row !important;
  justify-content:flex-start !important;
  text-align:left !important;
  gap: 12px;
  padding: 12px 14px;
}
body.show-admin .profile-wrapper{
  width: 56px !important;
  height: 56px !important;
  margin: 0 !important;
}
body.show-admin .profile-img{ border-radius: 18px !important; }
body.show-admin .info-area{ width: auto !important; flex: 1; }
body.show-admin .chk-wrapper{
  position: static !important;
  margin-left: auto;
  width: auto;
  display:flex;
  align-items:center;
}
body.show-admin .list-chk{
  width: 22px;
  height: 22px;
}
body.show-admin #selectedCount{
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(59,130,246,.10);
  border: 1px solid rgba(59,130,246,.12);
}
body.show-admin #selectAll{
  width: 20px;
  height: 20px;
  accent-color: var(--brand-blue);
}

/* ===== Cute sparkle (cat accent) ===== */
.sparkle-fx{
  position: absolute;
  width: 16px;
  height: 16px;
  pointer-events:none;
  animation: sparkle-pop .55s ease-out forwards;
  filter: drop-shadow(0 10px 14px rgba(250,204,21,.25));
}
@keyframes sparkle-pop{
  0%{ transform: translate(-50%,-50%) scale(.2); opacity:0; }
  35%{ opacity:1; transform: translate(-50%,-50%) scale(1); }
  100%{ opacity:0; transform: translate(-50%,-80%) scale(.8); }
}


/* =========================
   KIOSK: True metal/plastic card feel + remove ghost print text
   ========================= */

/* Hide print area during normal use (it was showing at bottom) */
#printArea{ display:none !important; }

/* Print support: show printArea only when printing */
@media print{
  body{ background:#fff !important; padding:0 !important; }
  body > *:not(#printArea){ display:none !important; }
  #printArea{
    display:block !important;
    position: static !important;
    width: 210mm !important;
    padding: 10mm !important;
  }
}

/* Remove any watermark/label that looks like floating text */
.card-label{ display:none !important; }

/* Stronger "kiosk" look */
body.kiosk-mode{
  background:
    radial-gradient(900px 540px at 15% 0%, rgba(59,130,246,.28) 0%, rgba(59,130,246,0) 55%),
    radial-gradient(720px 520px at 85% 10%, rgba(250,204,21,.30) 0%, rgba(250,204,21,0) 55%),
    linear-gradient(180deg, #F8FAFC 0%, #EEF2FF 100%) !important;
}

/* Kiosk cards: metal + plastic hybrid */
body.kiosk-mode .student-card{
  height: 380px;
  border-radius: 30px;
  padding: 18px 16px;
  cursor: pointer;

  /* "metal shell" */
  background:
    radial-gradient(140px 120px at 25% 22%, rgba(255,255,255,.95) 0%, rgba(255,255,255,0) 60%),
    radial-gradient(260px 180px at 70% 28%, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 62%),
    linear-gradient(135deg, rgba(15,23,42,.10) 0%, rgba(255,255,255,.92) 22%, rgba(255,255,255,.86) 60%, rgba(15,23,42,.10) 100%);

  border: 1px solid rgba(15,23,42,.12);

  /* 3D plate + floor shadow */
  box-shadow:
    0 18px 0 rgba(148,163,184,.30),
    0 34px 54px rgba(2,6,23,.22);

  position: relative;
  overflow: hidden;
  transform: translateZ(0);
}

/* glossy highlight strip */
body.kiosk-mode .student-card::before{
  content:"";
  position:absolute;
  inset: -40% -30%;
  background: linear-gradient(115deg,
    rgba(255,255,255,0) 20%,
    rgba(255,255,255,.28) 38%,
    rgba(255,255,255,0) 58%);
  transform: rotate(12deg);
  opacity: .9;
  pointer-events:none;
}

/* subtle noise to feel "plastic" */
body.kiosk-mode .student-card::after{
  content:"";
  position:absolute;
  inset:0;
  background-image:
    radial-gradient(rgba(15,23,42,.06) 1px, rgba(255,255,255,0) 1px);
  background-size: 18px 18px;
  opacity: .06;
  mix-blend-mode: multiply;
  pointer-events:none;
}

body.kiosk-mode .student-card:active{
  transform: translateY(12px);
  box-shadow:
    0 8px 0 rgba(148,163,184,.28),
    0 22px 36px rgba(2,6,23,.18);
}

/* Arrived state: green glow rim */
body.kiosk-mode .student-card.arrived{
  border-color: rgba(34,197,94,.30) !important;
  box-shadow:
    0 18px 0 rgba(148,163,184,.28),
    0 34px 54px rgba(2,6,23,.20),
    0 0 0 2px rgba(34,197,94,.18) inset,
    0 0 26px rgba(34,197,94,.14);
}

/* Profile: inset frame like ID */
body.kiosk-mode .profile-wrapper{
  width: 154px;
  height: 154px;
  border-radius: 26px;
  padding: 6px;
  background:
    linear-gradient(145deg, rgba(255,255,255,.9) 0%, rgba(15,23,42,.08) 100%);
  box-shadow:
    0 10px 22px rgba(2,6,23,.20),
    0 0 0 1px rgba(15,23,42,.10) inset;
}
body.kiosk-mode .profile-img{
  border-radius: 20px;
}

/* Title typography */
body.kiosk-mode .info-area div:first-child{
  font-size: 30px !important;
  letter-spacing: -0.6px;
}
body.kiosk-mode .info-area small{
  font-size: 14px !important;
  color: rgba(71,85,105,.85) !important;
}

/* Buttons: tactile plastic/metal */
body.kiosk-mode .kiosk-btn-group{ gap: 12px; }

.k-btn{
  border-radius: 20px !important;
  font-size: 17px !important;
  font-weight: 950 !important;
  letter-spacing: -0.2px;
  position: relative;
  overflow: hidden;
}

.k-btn::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(180deg, rgba(255,255,255,.55) 0%, rgba(255,255,255,0) 55%);
  opacity:.55;
  pointer-events:none;
}

/* "Gold plastic" for ë“±ì› */
.k-btn-in{
  background:
    radial-gradient(120px 60px at 30% 20%, rgba(255,255,255,.75) 0%, rgba(255,255,255,0) 60%),
    linear-gradient(135deg, rgba(161,98,7,.22) 0%, rgba(250,204,21,.95) 26%, rgba(250,204,21,.62) 70%, rgba(161,98,7,.22) 100%) !important;
  color: #3B2A00 !important;
  border: 1px solid rgba(161,98,7,.22) !important;
  box-shadow:
    0 10px 0 rgba(161,98,7,.20),
    0 18px 28px rgba(2,6,23,.18) !important;
}

/* "Steel" for í•˜ì› */
.k-btn-out{
  background:
    radial-gradient(120px 60px at 30% 20%, rgba(255,255,255,.8) 0%, rgba(255,255,255,0) 60%),
    linear-gradient(135deg, rgba(15,23,42,.18) 0%, rgba(226,232,240,.95) 28%, rgba(203,213,225,.70) 70%, rgba(15,23,42,.14) 100%) !important;
  color: #0F172A !important;
  border: 1px solid rgba(15,23,42,.14) !important;
  box-shadow:
    0 10px 0 rgba(15,23,42,.12),
    0 18px 28px rgba(2,6,23,.16) !important;
}

.k-btn:active{
  transform: translateY(6px) !important;
  box-shadow: none !important;
}

/* Kiosk exit button: clearer */
body.kiosk-mode .kiosk-exit-btn{
  background: rgba(255,255,255,.85) !important;
  box-shadow: 0 22px 50px rgba(2,6,23,.18) !important;
}

/* Kiosk header chips slightly more premium */
body.kiosk-mode .kiosk-header{
  border-radius: 26px !important;
}
/* [ìˆ˜ì •] ì‹ ê·œ ë“±ë¡ í™”ë©´ í•˜ë‹¨ ì—¬ë°± ì¶”ê°€ (ë²„íŠ¼ ê°€ë¦¼ ë°©ì§€) */
    #register {
        padding-bottom: 90px !important;
    }

    /* [ìˆ˜ì •] ì„ ìƒë‹˜ ëª¨ë“œ ì‹œ ì„¤ì • ë²„íŠ¼ ê°•ì œ í‘œì‹œ */
    body.show-admin .admin-only {
        display: inline-flex !important;
    }
</style>
</head>
<body>

<div class="kiosk-exit-btn" onclick="exitKioskMode()">
    <i class="fas fa-lock"></i>
</div>

<div class="container">
    <div class="kiosk-header" id="kioskHeader">
        <button class="k-filter-btn active" onclick="setKioskCategory('all', this)">ì „ì²´</button>
        <button class="k-filter-btn" onclick="setKioskCategory('ë¯¸ì·¨í•™', this)">ë¯¸ì·¨í•™</button>
        <button class="k-filter-btn" onclick="setKioskCategory('ì´ˆë“±', this)">ì´ˆë“±ë¶€</button>
        <button class="k-filter-btn" onclick="setKioskCategory('ì¤‘ë“±', this)">ì¤‘ë“±ë¶€</button>
        <button class="k-filter-btn" onclick="setKioskCategory('ê³ ë“±', this)">ê³ ë“±ë¶€</button>
    </div>

<header>
        <div class="brand">
            <img class="brand-mark" src="nam-512.png" alt="ëŠ¥ë™í•´ëƒ„" onerror="this.style.display='none'">
            <div class="brand-title">
                <strong>ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„</strong>
                <span>í•™ë¶€ëª¨ìš© Â· ì•Œë¦¼/ì¶œì„/ìƒë‹´</span>
            </div>
        </div>
        
        <div style="display:flex; align-items:center; gap:8px;">
            <label class="admin-switch" style="margin:0; cursor:pointer;">
                <input type="checkbox" id="adminToggle" onclick="toggleAdminMode()" style="width:auto; margin-right:6px;"> ì„ ìƒë‹˜
            </label>
           <button class="admin-only" onclick="document.getElementById('settingsModal').style.display='flex'" 
        style="border:none; background:white; width:36px; height:36px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.1); color:#555;">
    <i class="fas fa-cog"></i>
</button>
        </div>
    </header>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="showPage('register')"><i class="fas fa-user-plus"></i> ì‹ ê·œ ë“±ë¡</button>
        <button class="tab-btn" onclick="showPage('list')"><i class="fas fa-users"></i> ì›ìƒ ê´€ë¦¬</button>
        <button class="tab-btn" onclick="showPage('calendar')"><i class="fas fa-calendar-alt"></i> í•™ìŠµ ì¼ì •</button>
    </div>

    <div id="register" class="page active">
        <div class="form-grid">
            <div class="full-width">
                <label>í•™ìƒ ì‚¬ì§„</label>
                <input type="file" id="regPhoto" accept="image/*">
            </div>
            <div>
                <label>ì´ë¦„</label>
                <input type="text" id="regName" placeholder="ì˜ˆ: ê¹€ìˆ˜í•™">
            </div>
            <div>
                <label>ìƒë…„ì›”ì¼</label>
                <input type="date" id="regBirth">
            </div>
            <div>
                <label>ì„±ë³„</label>
                <select id="regGender">
                    <option value="ë‚¨">ë‚¨ì</option>
                    <option value="ì—¬">ì—¬ì</option>
                </select>
            </div>
            <div>
                <label>í•™êµ</label>
                <input type="text" id="regSchool" placeholder="ì˜ˆ: ëŠ¥ë™ì´ˆ">
            </div>
            <div>
                <label>í•™ë…„/ê³¼ì •</label>
                <select id="regGrade">
                    <option value="ë¯¸ì·¨í•™">ë¯¸ì·¨í•™</option>
                    <option value="ì´ˆë“±1-2">ì´ˆë“± 1~2í•™ë…„</option>
                    <option value="ì´ˆë“±3-4">ì´ˆë“± 3~4í•™ë…„</option>
                    <option value="ì´ˆë“±5-6">ì´ˆë“± 5~6í•™ë…„</option>
                    <option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option>
                    <option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option>
                </select>
            </div>
            <div class="full-width" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="color:var(--primary);">í•™ë¶€ëª¨ ì—°ë½ì²˜ (ì•Œë¦¼ìš©)</label>
                    <input type="tel" id="regParentPhone" placeholder="01012345678">
                </div>
                <div>
                    <label>í•™ìƒ ë³¸ì¸ ì—°ë½ì²˜</label>
                    <input type="tel" id="regStudentPhone" placeholder="01012345678">
                </div>
            </div>
            <div class="full-width">
                <label>ì£¼ì†Œ</label>
                <input type="text" id="regAddress" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="full-width">
                <label>í•™ìŠµ íŠ¹ì´ì‚¬í•­ (ì§„ë„, ì„±í–¥ ë“±)</label>
                <textarea id="regNotes" rows="3" placeholder="ìƒë‹´ ë° ì§€ë„ ì‹œ ì°¸ê³ í•  ì‚¬í•­"></textarea>
            </div>
        </div>
        <button class="action-btn" id="addBtn">í•™ìƒ ë“±ë¡í•˜ê¸°</button>
    </div>

  <div id="list" class="page">
        <div class="filter-container">
            <div class="filter-row">
                <span class="filter-label">ê³¼ì •</span>
                <div class="filter-group" id="ageFilterGroup">
                    <div class="filter-chip active" onclick="setGradeFilter('all', this)">ì „ì²´</div>
                    <div class="filter-chip" onclick="setGradeFilter('ë¯¸ì·¨í•™', this)">ë¯¸ì·¨í•™</div>
                    <div class="filter-chip" onclick="setGradeFilter('ì´ˆë“±', this)">ì´ˆë“±ë¶€</div>
                    <div class="filter-chip" onclick="setGradeFilter('ì¤‘ë“±', this)">ì¤‘ë“±ë¶€</div>
                    <div class="filter-chip" onclick="setGradeFilter('ê³ ë“±', this)">ê³ ë“±ë¶€</div>
                </div>
            </div>
            <div class="filter-row">
                <span class="filter-label">ê²€ìƒ‰</span>
                <input type="text" id="searchKeyword" placeholder="ì´ë¦„ ê²€ìƒ‰" onkeyup="filterList()" style="flex:1;">
                <select id="schoolFilter" onchange="filterList()" style="width: auto; flex:1;">
                    <option value="all">ì „ì²´ í•™êµ</option>
                </select>
            </div>
        </div>
        
        <div id="studentListArea">ë¡œë”©ì¤‘...</div>
    </div>

<div id="calendar" class="page">
    <div class="calendar-controls">
        <button class="cal-btn" onclick="changeCalDate(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="current-date" id="calTitle"></div>
        <button class="cal-btn" onclick="changeCalDate(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="filter-group" style="justify-content:center; margin-bottom:10px;">
        <label><input type="checkbox" id="showSchedule" checked onchange="renderCalendar()"> í•™ì›ì¼ì •</label> &nbsp;
        <label><input type="checkbox" id="showBirthday" checked onchange="renderCalendar()"> ìƒì¼</label>
    </div>

    <div class="calendar-grid">
        <div class="day-name" style="color:var(--danger)">ì¼</div><div class="day-name">ì›”</div><div class="day-name">í™”</div>
        <div class="day-name">ìˆ˜</div><div class="day-name">ëª©</div><div class="day-name">ê¸ˆ</div><div class="day-name" style="color:var(--primary)">í† </div>
    </div>
    <div class="calendar-grid" id="calGrid"></div>
    
<div id="dateDetailArea" style="margin-top:20px;">
        <div class="view-mode-group">
            <button class="view-mode-btn active" onclick="changeListView('day', this)">ì¼ê°„</button>
            <button class="view-mode-btn" onclick="changeListView('week', this)">ì£¼ê°„</button>
            <button class="view-mode-btn" onclick="changeListView('month', this)">ì›”ê°„</button>
            <button class="view-mode-btn" onclick="changeListView('year', this)">ì—°ê°„</button>
        </div>

        <h3 id="selectedDateText" style="font-size:15px; margin-bottom:10px; border-bottom:2px solid var(--primary); padding-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
            <span>ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            <button class="action-btn admin-only" id="addSchedBtn" onclick="openScheduleModal()" style="width:auto; margin:0; padding:5px 10px; font-size:12px; display:none;">+ ì¼ì • ë“±ë¡</button>
        </h3>
        
        <div id="dailyEventList" style="max-height:300px; overflow-y:auto;"></div>
    </div>
</div>

<div class="modal-overlay" id="scheduleModal">
    <div class="modal" style="max-width:340px;">
        <h3 id="schedModalTitle" style="margin-top:0;">ğŸ“… ì¼ì • ê´€ë¦¬</h3>
        
        <div style="margin-bottom:15px;">
            <label style="margin-bottom:5px;">ë“±ë¡ëœ ì¼ì •</label>
            <div id="popupSchedList" style="background:#f1f5f9; padding:10px; border-radius:8px; min-height:50px; max-height:120px; overflow-y:auto; font-size:13px;">
                </div>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin:15px 0;">

        <label>ë‚ ì§œ ì„ íƒ</label>
        <input type="date" id="schedDate" style="margin-bottom:10px;">
        
        <label>ì¼ì • ë‚´ìš©</label>
        <input type="hidden" id="schedId"> <input type="text" id="schedTitle" placeholder="ìƒˆ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ ëª©ë¡ì„ í´ë¦­" style="margin-bottom:15px;">
        
        <div class="modal-btn-group" style="display:flex; gap:8px;">
            <button class="action-btn" onclick="saveSchedule()" style="margin:0; flex:2;">ì €ì¥/ì¶”ê°€</button>
            <button class="action-btn" onclick="deleteSchedule()" id="btnDelSched" style="margin:0; flex:1; background:var(--danger); display:none;">ì‚­ì œ</button>
            <button class="action-btn" onclick="document.getElementById('scheduleModal').style.display='none'" style="margin:0; flex:1; background:#94a3b8;">ë‹«ê¸°</button>
        </div>
    </div>
</div>
        
        <div class="modal-btn-group">
            <button class="action-btn" onclick="saveSchedule()" style="margin:0; flex:1;">ì €ì¥</button>
            <button class="action-btn" onclick="deleteSchedule()" id="btnDelSched" style="margin:0; flex:1; background:var(--danger); display:none;">ì‚­ì œ</button>
            <button class="action-btn" onclick="document.getElementById('scheduleModal').style.display='none'" style="margin:0; flex:1; background:#90a4ae;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <button class="close-btn" onclick="closeModal()">Ã—</button>
        
        <div class="modal-header-profile">
            <div style="width:80px; height:80px; margin:0 auto; position:relative;" onclick="triggerPhotoEdit()">
                <img id="modalImg" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid var(--secondary); box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                <div class="admin-only" style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; padding:4px 7px; border-radius:50%; font-size:11px;"><i class="fas fa-camera"></i></div>
            </div>
            <h2 id="modalName" style="margin:8px 0 4px 0; font-size:20px;"></h2>
            <div id="modalInfo" style="color:var(--text-sub); font-size:13px; margin-bottom:10px;"></div>
            
            <div class="contact-row">
                <div class="contact-group">
                    <span class="contact-label">í•™ìƒ</span>
                    <a id="linkCallStu" class="contact-btn btn-call"><i class="fas fa-phone"></i></a>
                    <a id="linkSmsStu" class="contact-btn btn-sms"><i class="fas fa-comment-dots"></i></a>
                    <a id="linkKakaoStu" class="contact-btn btn-kakao" onclick="sendKakaoToTarget('student')"><i class="fas fa-comment"></i></a>
                </div>
                <div style="width:1px; height:20px; background:#ddd;"></div>
                <div class="contact-group">
                    <span class="contact-label">ë¶€ëª¨</span>
                    <a id="linkCallPar" class="contact-btn btn-call"><i class="fas fa-phone"></i></a>
                    <a id="linkSmsPar" class="contact-btn btn-sms"><i class="fas fa-comment-dots"></i></a>
                    <a id="linkKakaoPar" class="contact-btn btn-kakao" onclick="sendKakaoToTarget('parent')"><i class="fas fa-comment"></i></a>
                </div>
            </div>
            <input type="file" id="editPhotoInput" accept="image/*" style="display:none;" onchange="previewEditPhoto()">
        </div>

        <div class="modal-tab-nav">
            <button class="modal-tab-btn active" onclick="switchModalTab('tabDaily', this)">ğŸ“‹ í•™ìŠµ/ì¶œì„</button>
            <button class="modal-tab-btn" onclick="switchModalTab('tabScore', this)">ğŸ“ˆ ì„±ì /ìƒë‹´</button>
            <button class="modal-tab-btn" onclick="switchModalTab('tabInfo', this)">âš™ï¸ ì •ë³´/ì •ì‚°</button>
        </div>

<div id="tabDaily" class="modal-tab-pane active">
    <div class="stat-box" style="margin: 0 0 15px 0;">
        <div class="stat-item"><div class="stat-num" id="statMonth">0%</div><div style="font-size:12px;">ì´ë²ˆë‹¬ ì¶œì„ë¥ </div></div>
        <div class="stat-item"><div class="stat-num" id="statTotal">0íšŒ</div><div style="font-size:12px;">ì´ ë“±ì›ì¼</div></div>
    </div>

    <div style="background:#fffde7; border:1px solid #fff9c4; border-radius:10px; padding:15px;">
        <h4 style="margin:0 0 10px 0; color:#fbc02d;"><i class="fas fa-bullhorn"></i> ì˜¤ëŠ˜ì˜ í•™ìŠµ ì•ˆë‚´</h4>
        <textarea id="dailyProgress" rows="3" placeholder="ì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="background:white; margin-bottom:8px;"></textarea>
        
        <div id="noticePreview" style="background:white; padding:10px; border:1px dashed #ddd; font-size:12px; white-space:pre-wrap; color:#555; margin-bottom:8px; min-height:40px;">(ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°)</div>

        <div class="modal-action-row" style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
            <button class="action-btn" onclick="generateNotice()" style="background:#fbc02d; margin:0; font-size:13px; padding:10px 0;">ğŸ“ ì–‘ì‹</button>
            <button class="action-btn" onclick="copyNotice()" style="background:#ffa000; margin:0; font-size:13px; padding:10px 0;">ğŸ“‹ ë³µì‚¬</button>
            <button class="action-btn" onclick="sendNoticeSms()" style="background:#4caf50; margin:0; font-size:13px; padding:10px 0;">ğŸ“© ë¬¸ì</button>
            <button class="action-btn" onclick="sendNoticeKakao()" style="background:#fee500; color:#3c1e1e; margin:0; font-size:13px; padding:10px 0;">ğŸŸ¡ ì¹´í†¡</button>
        </div>
    </div>
</div>
        <div id="tabScore" class="modal-tab-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:var(--text-main);">ğŸ’¬ ìƒë‹´ ë° í•™ìŠµ ë¡œê·¸</h4>
                <span style="font-size:12px; color:#999;">ìµœê·¼ ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</span>
            </div>

            <div id="modalCounselLog" style="background:#f5f7f9; border-radius:8px; padding:15px; height:250px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee;"></div>
            
            <div class="admin-only" style="display:flex; gap:5px; margin-bottom:20px;">
                <input type="text" id="newCounsel" placeholder="ìƒë‹´ ë‚´ìš© ê¸°ë¡" style="flex:1;">
                <button onclick="addCounselLog()" style="background:var(--primary); color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold;">ë“±ë¡</button>
            </div>

            <details style="background:white; border:1px solid #e0e0e0; border-radius:10px; padding:10px;">
                <summary style="font-weight:bold; color:#7b1fa2; cursor:pointer; padding:5px; list-style:none; display:flex; align-items:center; justify-content:space-between;">
                    <span>ğŸ“ˆ ì„±ì  ê·¸ë˜í”„ ë° ê¸°ë¡ ê´€ë¦¬</span>
                    <i class="fas fa-chevron-down" style="font-size:12px; color:#aaa;"></i>
                </summary>
                
                <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #eee;">
                    <div class="chart-container" style="padding:0; margin-bottom:15px; border:none;">
                        <canvas id="scoreChart" height="180"></canvas>
                    </div>

                    <div class="admin-only" style="background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px;">
                        <div style="font-size:12px; font-weight:bold; color:#7b1fa2; margin-bottom:5px;">ìƒˆ ì„±ì  ë“±ë¡</div>
                        <div class="score-input-group">
                            <input type="text" id="scoreTitle" placeholder="ì‹œí—˜ëª…" style="flex:1.5;">
                            <input type="number" id="scoreValue" placeholder="ì ìˆ˜" style="flex:1;">
                            <button onclick="addScore()" style="background:#7b1fa2; color:white; border:none; padding:0 15px; border-radius:6px;">ì¶”ê°€</button>
                        </div>
                    </div>

                    <h5 style="margin:0 0 8px 0; color:#555;">ğŸ“ ì„±ì  ê¸°ë¡ ìƒì„¸</h5>
                    <div id="scoreList" style="font-size:13px; max-height:150px; overflow-y:auto; color:#666;"></div>
                </div>
            </details>
        </div>

        <div id="tabInfo" class="modal-tab-pane">
            <div class="settlement-box" style="margin-top:0;">
                <h4 class="settlement-title" style="margin-top:0;"><i class="fas fa-file-invoice-dollar"></i> êµìœ¡ë¹„ ì •ì‚° ì•ˆë‚´</h4>
                <div id="settlementPreview" style="background:white; padding:10px; border:1px solid #bbdefb; font-size:12px; white-space:pre-wrap; margin-bottom:8px; color:#333;"></div>
                <div class="modal-action-row">
                    <button onclick="generateSettlement()" class="action-btn" style="background:#1976d2; margin-top:0;">ë¬¸êµ¬ ìƒì„±</button>
                    <button onclick="copyText('settlementPreview')" class="action-btn" style="background:#1565c0; margin-top:0;">ë³µì‚¬</button>
                </div>
            </div>

            <div class="admin-only">
                <h4 style="margin:20px 0 10px 0; border-top:1px solid #eee; padding-top:15px;">í•™ìƒ ì •ë³´ ìˆ˜ì •</h4>
                <div id="modalEditForm" class="form-grid" style="grid-template-columns: 1fr;">
                    <input type="hidden" id="editId">
                    <div><label>ì´ë¦„</label><input type="text" id="editName"></div>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label>ìƒë…„ì›”ì¼</label><input type="date" id="editBirth"></div>
                        <div style="flex:1;"><label>ì„±ë³„</label><select id="editGender"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div>
                    </div>
                    <div><label>í•™ë…„/ê³¼ì •</label>
                        <select id="editGrade"> 
                            <option value="ë¯¸ì·¨í•™">ë¯¸ì·¨í•™</option><option value="ì´ˆë“±1-2">ì´ˆë“± 1~2í•™ë…„</option>
                            <option value="ì´ˆë“±3-4">ì´ˆë“± 3~4í•™ë…„</option><option value="ì´ˆë“±5-6">ì´ˆë“± 5~6í•™ë…„</option>
                            <option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option><option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option>
                        </select>
                    </div>
                    <div><label>í•™êµ</label><input type="text" id="editSchool"></div>
                    <div><label>ë¶€ëª¨ë‹˜ ì—°ë½ì²˜</label><input type="tel" id="editParentPhone"></div>
                    <div><label>í•™ìƒ ì—°ë½ì²˜</label><input type="tel" id="editStudentPhone"></div>
                    <div><label>ì£¼ì†Œ</label><input type="text" id="editAddress"></div>
                    <div><label>íŠ¹ì´ì‚¬í•­</label><textarea id="editNotes" rows="2"></textarea></div>
                </div>
                <div class="modal-action-row" style="margin-top:15px;">
                    <button class="action-btn" onclick="saveEdit()" style="background:var(--primary); margin-top:0;">ì €ì¥</button>
                    <button class="action-btn" onclick="deleteStudent()" style="background:var(--danger); margin-top:0;">ì‚­ì œ</button>
                </div>
            </div>
            
            <p style="text-align:center; color:#999; font-size:12px; margin-top:20px;">
                * ì •ë³´ ìˆ˜ì • ë° ì •ì‚° ê¸°ëŠ¥ì€<br>ì„ ìƒë‹˜ ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div><div id="printArea">
    <div style="text-align:center; font-size:24px; font-weight:bold; text-decoration:underline;">ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„ êµì‹¤ ì›ìƒ ëª…ë‹¨</div>
    <div style="text-align:right; font-size:12px; margin-top:10px;" id="printDate"></div>
    <table class="print-table">
        <thead>
            <tr><th>No</th><th>ì´ë¦„</th><th>í•™ë…„/ê³¼ì •</th><th>í•™êµ</th><th>í•™ë¶€ëª¨ ì—°ë½ì²˜</th><th>í•™ìƒ ì—°ë½ì²˜</th></tr>
        </thead>
        <tbody id="printTbody"></tbody>
    </table>
</div>

<script type="module">
    // =========================================================
    // 1. Firebase ì„¤ì • ë° SDK ë¡œë“œ
    // =========================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, getDoc, setDoc, arrayUnion, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
      authDomain: "namyang-f3a98.firebaseapp.com",
      projectId: "namyang-f3a98",
      storageBucket: "namyang-f3a98.firebasestorage.app",
      messagingSenderId: "641432133626",
      appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
      measurementId: "G-23L6KZERMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // =========================================================
    // 2. SMS ì„œë²„ ì„¤ì • (ì¹´í˜24 ì•Œë¦¬ê³ )
    // =========================================================
    const SMS_SERVER_BASE = "http://canyone2302.cafe24app.com"; 
    const SMS_CLIENT_KEY = "CHANGE_ME_TO_A_LONG_RANDOM_STRING";

    async function sendSmsByServer(receiver, msg) {
      try {
          const res = await fetch(`${SMS_SERVER_BASE}/send-sms`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "x-api-key": SMS_CLIENT_KEY },
            body: JSON.stringify({ receiver, msg })
          });
          const data = await res.json().catch(async () => ({ raw: await res.text() }));
          const ok = data.success === true || data.result_code === "1" || data.result_code === 1;
          return { ok, data };
      } catch (e) {
          console.error("SMS ë°œì†¡ ì‹¤íŒ¨:", e);
          return { ok: false, error: e };
      }
    }

    // =========================================================
    // 3. ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
    // =========================================================
    let allStudents = [];
    let allSchedules = [];
    let currentStudentId = null;
    let selectedStudentIds = new Set();
    let selectedDateStr = new Date().toISOString().slice(0, 10);
    
    // í•„í„° ë° ë·° ìƒíƒœ
    let currentGradeFilter = 'all'; 
    let currentKioskCategory = 'all';
    let calDate = new Date();
    let myChart = null; // ì°¨íŠ¸ ê°ì²´ ì €ì¥ìš©

    // =========================================================
    // 4. ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™” (onSnapshot)
    // =========================================================
    
    // í•™ìƒ ë°ì´í„° ë¡œë“œ
    onSnapshot(collection(db, "students"), (snapshot) => {
        allStudents = [];
        snapshot.forEach((doc) => { allStudents.push({ id: doc.id, ...doc.data() }); });
        
        updateSchoolOptions(); // í•™êµ í•„í„° ê°±ì‹ 
        filterList();          // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        if(window.renderCalendar) renderCalendar(); // ë‹¬ë ¥ ìƒì¼ ê°±ì‹ 
        
        // ìƒì„¸ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‚´ìš© ê°±ì‹  (ì‹¤ì‹œê°„ì„±)
        if(document.getElementById('detailModal').style.display === 'flex' && currentStudentId) {
            const s = allStudents.find(st => st.id === currentStudentId);
            if(s) window.openDetail(s);
        }
    });

    // ì¼ì • ë°ì´í„° ë¡œë“œ
    onSnapshot(query(collection(db, "schedules"), orderBy("date")), (snapshot) => {
        allSchedules = [];
        snapshot.forEach((doc) => { allSchedules.push({ id: doc.id, ...doc.data() }); });
        if(window.renderCalendar) renderCalendar();
    });

    function updateSchoolOptions() {
        const schools = new Set();
        allStudents.forEach(s => { if(s.school) schools.add(s.school); });
        const select = document.getElementById('schoolFilter');
        if(select) {
            select.innerHTML = '<option value="all">ì „ì²´ í•™êµ</option>';
            Array.from(schools).sort().forEach(sc => select.innerHTML += `<option value="${sc}">${sc}</option>`);
        }
    }

    // =========================================================
    // 5. [ê¸°ëŠ¥ ë³µêµ¬] ì‹ ê·œ í•™ìƒ ë“±ë¡ ë¡œì§
    // =========================================================
    const addBtn = document.getElementById('addBtn');
    if(addBtn) {
        addBtn.addEventListener('click', async () => {
            const name = document.getElementById('regName').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const btn = document.getElementById('addBtn');
            const originText = btn.innerText;
            btn.innerText = "ë“±ë¡ ì¤‘...";
            btn.disabled = true;

            try {
                // ì‚¬ì§„ ì²˜ë¦¬
                let photoUrl = "";
                const file = document.getElementById('regPhoto').files[0];
                if(file) photoUrl = await resizeImage(file);

                const newStudent = {
                    name: name,
                    birth: document.getElementById('regBirth').value,
                    gender: document.getElementById('regGender').value,
                    school: document.getElementById('regSchool').value,
                    belt: document.getElementById('regGrade').value,
                    phone: document.getElementById('regParentPhone').value,
                    studentPhone: document.getElementById('regStudentPhone').value,
                    address: document.getElementById('regAddress').value,
                    notes: document.getElementById('regNotes').value,
                    photo: photoUrl,
                    regDate: serverTimestamp(),
                    attendanceLog: [],
                    attendanceOutLog: [],
                    scoreLog: [],
                    counselLog: []
                };

                await addDoc(collection(db, "students"), newStudent);
                alert("í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                
                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                document.querySelectorAll('#register input, #register textarea').forEach(el => el.value = '');
                document.getElementById('regGrade').value = 'ë¯¸ì·¨í•™';
                
                // ë¦¬ìŠ¤íŠ¸ íƒ­ìœ¼ë¡œ ì´ë™
                window.showPage('list');

            } catch(e) {
                console.error(e);
                alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerText = originText;
                btn.disabled = false;
            }
        });
    }

    // =========================================================
    // 6. ë¦¬ìŠ¤íŠ¸ ë° í•„í„°ë§ (ì˜¤ë¥˜ ìˆ˜ì •ë¨)
    // =========================================================
    window.setGradeFilter = (val, btn) => {
        currentGradeFilter = val;
        document.querySelectorAll('#ageFilterGroup .filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        filterList();
    };

    // [ìˆ˜ì •] ì•ˆì „í•˜ê²Œ ë‹¤ì‹œ ì‘ì„±ëœ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ í•¨ìˆ˜
    window.filterList = () => {
        // 1. ê²€ìƒ‰ì–´ ë° í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
        let keyword = "";
        const searchInput = document.getElementById('searchKeyword');
        // í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ê²€ìƒ‰ì–´ ì ìš©
        if(searchInput && !document.body.classList.contains('kiosk-mode')) {
            keyword = searchInput.value.toLowerCase();
        }
        
        const schoolFilter = document.getElementById('schoolFilter') ? document.getElementById('schoolFilter').value : 'all';
        const todayStr = new Date().toDateString();
        const isKiosk = document.body.classList.contains('kiosk-mode');

        // 2. í•™ìƒ ë°ì´í„° í•„í„°ë§
        let filtered = allStudents.filter(s => {
            // ì´ë¦„ì´ë‚˜ í•™ë…„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•´ ì—ëŸ¬ ë°©ì§€
            const sName = s.name ? s.name.toLowerCase() : "";
            const sSchool = s.school || "";
            const sBelt = s.belt || "";

            if (!isKiosk) {
                // [ì„ ìƒë‹˜ ëª¨ë“œ] ê²€ìƒ‰ì–´ AND í•™êµ AND í•™ë…„
                const matchName = sName.includes(keyword);
                const matchSchool = schoolFilter === 'all' || sSchool === schoolFilter;
                const matchGrade = currentGradeFilter === 'all' || sBelt === currentGradeFilter;
                return matchName && matchSchool && matchGrade;
            } else {
                // [í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ] ìƒë‹¨ íƒ­ ë¶„ë¥˜ (ì´ˆë“±/ì¤‘ë“± ë“±)
                if (currentKioskCategory === 'all') return true;
                return sBelt.includes(currentKioskCategory);
            }
        });
        
        // 3. ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
        filtered.sort((a, b) => a.name.localeCompare(b.name));
        
        // 4. í™”ë©´ ì´ˆê¸°í™”
        const listArea = document.getElementById('studentListArea');
        if(!listArea) return;
        listArea.innerHTML = "";
        
        if(filtered.length === 0) {
            listArea.innerHTML = "<div style='text-align:center; padding:20px; color:#999; width:100%;'>ê²€ìƒ‰ëœ ì›ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        // 5. ì¹´ë“œ ìƒì„± (ì—¬ê¸°ê°€ ì¤‘ìš”)
        filtered.forEach(s => {
            const imgSrc = s.photo || "https://via.placeholder.com/150?text=NO+IMAGE";
            
            // ë“±/í•˜ì› ì—¬ë¶€ ì²´í¬
            const hasArrived = (s.attendanceLog || []).some(log => {
                const d = log.toDate ? log.toDate() : new Date(log.seconds * 1000);
                return d.toDateString() === todayStr;
            });
            const hasLeft = (s.attendanceOutLog || []).some(log => {
                const d = log.toDate ? log.toDate() : new Date(log.seconds * 1000);
                return d.toDateString() === todayStr;
            });

            const div = document.createElement('div');
            div.id = `card-${s.id}`;
            
            if (isKiosk) {
                // --- [A] í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ ë””ìì¸ ---
                const stateClass = hasLeft ? 'left' : (hasArrived ? 'arrived' : 'missing');
                const pillText = hasLeft ? 'í•˜ì› ì™„ë£Œ' : (hasArrived ? 'ë“±ì› ì™„ë£Œ' : 'ë¯¸ë“±ì›');
                const hint = hasLeft
                  ? 'ì™„ë£Œ ìƒíƒœ'
                  : (hasArrived ? '<strong>í•œ ë²ˆ ë” íƒ­</strong>í•˜ë©´ í•˜ì› ì²˜ë¦¬' : '<strong>í•œ ë²ˆ íƒ­</strong>í•˜ë©´ ë“±ì› ì²˜ë¦¬');

                div.className = `student-card ${stateClass}`;
                div.setAttribute('role','button');
                div.innerHTML = `
                    <div class="kiosk-pill ${stateClass}">${pillText}</div>
                    <div class="profile-wrapper"><img src="${imgSrc}" class="profile-img" alt=""></div>
                    <div class="info-area">
                        <div>${s.name}</div>
                        <small>${s.school || 'í•™êµë¯¸ì…ë ¥'} | <span style="color:#0F172A; font-weight:900;">${s.belt || 'í•™ë…„ì—†ìŒ'}</span></small>
                    </div>
                    <div class="kiosk-hint">${hint}</div>
                `;
                div.onclick = (e) => {
                    e.preventDefault();
                    window.kioskTapAttendance(s.id);
                };

            } else {
                // --- [B] ì„ ìƒë‹˜ ëª¨ë“œ ë””ìì¸ ---
                const stateClass = hasLeft ? 'left' : (hasArrived ? 'arrived' : 'missing');
                div.className = `student-card ${stateClass}`;
                
                div.innerHTML = `
                    <div class="profile-wrapper" style="width:55px; height:55px; margin:0;">
                        <img src="${imgSrc}" class="profile-img" style="border-radius:18px;">
                    </div>
                    <div class="info-area" style="text-align:left; padding-left:15px;">
                        <div>
                            <strong style="color:#333; font-size:16px;">${s.name}</strong> 
                            <span class="dept-badge">${s.belt || ''}</span>
                        </div>
                        <div style="font-size:13px; color:#777; margin-top:4px;">${s.school || ''}</div>
                    </div>
                `;
                div.onclick = () => window.openDetail(s);
            }
            listArea.appendChild(div);
        });
    };

    // =========================================================
    // 7. ìƒì„¸ì •ë³´ ë° ê·¸ë˜í”„ (Chart.js)
    // =========================================================
    window.openDetailById = (id) => {
        const s = allStudents.find(st => st.id === id);
        if(s) window.openDetail(s);
    };

    window.openDetail = (s) => {
        currentStudentId = s.id;
        document.getElementById('detailModal').style.display = 'flex';
        
        // ê¸°ë³¸ ì •ë³´
        document.getElementById('modalImg').src = s.photo || "https://via.placeholder.com/150";
        document.getElementById('modalName').innerText = s.name;
        document.getElementById('modalInfo').innerText = `${s.school||''} | ${s.belt||''}`;
        
        // ì—°ë½ì²˜ ë§í¬ ì—°ê²°
        const stuPhone = (s.studentPhone || "").replace(/[^0-9]/g, '');
        const parPhone = (s.phone || "").replace(/[^0-9]/g, '');
        document.getElementById('linkCallStu').href = stuPhone ? `tel:${stuPhone}` : "#";
        document.getElementById('linkSmsStu').href = stuPhone ? `sms:${stuPhone}` : "#";
        document.getElementById('linkCallPar').href = parPhone ? `tel:${parPhone}` : "#";
        document.getElementById('linkSmsPar').href = parPhone ? `sms:${parPhone}` : "#";

        // ìˆ˜ì • í¼ ì±„ìš°ê¸°
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editBirth').value = s.birth;
        document.getElementById('editGrade').value = s.belt;
        document.getElementById('editSchool').value = s.school || "";
        document.getElementById('editGender').value = s.gender;
        document.getElementById('editParentPhone').value = s.phone;
        document.getElementById('editStudentPhone').value = s.studentPhone || "";
        document.getElementById('editAddress').value = s.address || "";
        document.getElementById('editNotes').value = s.notes || "";

        // í†µê³„ ë° ì°¨íŠ¸ ë Œë”ë§
        if(window.calcStats) window.calcStats(s);
        if(window.renderScoreChart) window.renderScoreChart(s.scoreLog || []); 
        
        // ìƒë‹´ ë¡œê·¸ ë¡œë“œ
        renderCounselLog(s);

        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        if(document.getElementById('dailyProgress')) document.getElementById('dailyProgress').value = ""; 
        if(document.getElementById('newCounsel')) document.getElementById('newCounsel').value = "";
        if(document.getElementById('noticePreview')) document.getElementById('noticePreview').innerText = "(ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°)";
        if(document.getElementById('settlementPreview')) document.getElementById('settlementPreview').innerText = "";
    };

    // ìƒë‹´ ë¡œê·¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ë¶„ë¦¬
    function renderCounselLog(s) {
        const logArea = document.getElementById('modalCounselLog');
        if(!logArea) return;
        
        logArea.innerHTML = "";
        const logs = s.counselLog || [];
        if(logs.length === 0) {
            logArea.innerHTML = "<div style='color:#ccc; text-align:center; padding:10px;'>ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }
        
        logs.forEach((log, index) => {
            const div = document.createElement('div');
            div.style.marginBottom = "10px";
            div.style.padding = "8px";
            div.style.background = "#fff";
            div.style.borderRadius = "5px";
            div.style.border = "1px solid #eee";
            
            const btnHtml = `<div class="admin-only" style="float:right;">
                <i class="fas fa-pen" onclick="editCounselLog(${index})" style="cursor:pointer; color:#1976d2; margin-right:8px;"></i>
                <i class="fas fa-trash" onclick="deleteCounselLog(${index})" style="cursor:pointer; color:#d32f2f;"></i>
            </div>`;
            div.innerHTML = `${btnHtml}<span style="color:#009688; font-weight:bold;">[${log.date}]</span> <span>${log.text}</span><div style="clear:both;"></div>`;
            logArea.appendChild(div);
        });
    }

    // ì„±ì  ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ê¸°ëŠ¥ ë³µêµ¬ë¨)
    window.renderScoreChart = (scoreLog = []) => {
        const canvas = document.getElementById('scoreChart');
        if(!canvas) return; 
        const ctx = canvas.getContext('2d');
        
        if (myChart) myChart.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´ í›„ ì¬ìƒì„±

        const labels = scoreLog.map(item => item.title);
        const data = scoreLog.map(item => item.score);

        // ê·¸ë¼ë°ì´ì…˜ ë³µêµ¬
        const gradientStroke = ctx.createLinearGradient(0, 0, canvas.width, 0);
        gradientStroke.addColorStop(0, '#7b1fa2'); gradientStroke.addColorStop(1, '#e91e63');
        const gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
        gradientFill.addColorStop(0, 'rgba(123, 31, 162, 0.3)'); gradientFill.addColorStop(1, 'rgba(123, 31, 162, 0.0)');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì„±ì ', data: data, borderColor: gradientStroke, backgroundColor: gradientFill,
                    borderWidth: 3, pointBackgroundColor: '#fff', pointBorderColor: '#7b1fa2', pointRadius: 5, fill: true, tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { min: 0, max: 100 }, x: { grid: { display: false } } }
            }
        });

        // ì„±ì  ë¦¬ìŠ¤íŠ¸ë„ í•¨ê»˜ ë Œë”ë§
        const listArea = document.getElementById('scoreList');
        if(listArea) {
            if(scoreLog.length === 0) listArea.innerHTML = "<div style='text-align:center; padding:10px; color:#aaa;'>ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            else {
                listArea.innerHTML = scoreLog.map((s, index) => `
                    <div style="padding: 10px; margin-bottom: 6px; border-radius: 8px; background: #fff; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div><span style="font-weight:bold; color:#333;">${s.title}</span> <span style="font-size:12px; color:#888;">(${s.date})</span></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <strong style="color:#7b1fa2;">${s.score}ì </strong>
                            <div class="admin-only" style="display:flex; gap:5px;">
                                <i class="fas fa-pen" onclick="editScore(${index})" style="cursor:pointer; color:#1976d2;"></i>
                                <i class="fas fa-trash" onclick="deleteScore(${index})" style="cursor:pointer; color:#d32f2f;"></i>
                            </div>
                        </div>
                    </div>`
                ).reverse().join(''); 
            }
        }
    };

    // =========================================================
    // 8. ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ë“¤ (CRUD)
    // =========================================================
    
    // [ì„±ì ] ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ
    window.addScore = async () => {
        const title = document.getElementById('scoreTitle').value;
        const score = document.getElementById('scoreValue').value;
        if(!title || !score) return alert("ì‹œí—˜ëª…ê³¼ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        try {
            await updateDoc(doc(db, "students", currentStudentId), {
                scoreLog: arrayUnion({ date: new Date().toISOString().slice(0, 10), title: title, score: parseInt(score) })
            });
            document.getElementById('scoreTitle').value = "";
            document.getElementById('scoreValue').value = "";
            alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
    };
    window.editScore = async (index) => {
        const s = allStudents.find(st => st.id === currentStudentId);
        if (!s || !s.scoreLog) return;
        const old = s.scoreLog[index];
        const t = prompt("ì‹œí—˜ëª…:", old.title); if(t===null) return;
        const v = prompt("ì ìˆ˜:", old.score); if(v===null) return;
        const newLog = [...s.scoreLog];
        newLog[index] = { ...old, title: t, score: parseInt(v) };
        await updateDoc(doc(db, "students", currentStudentId), { scoreLog: newLog });
    };
    window.deleteScore = async (index) => {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const s = allStudents.find(st => st.id === currentStudentId);
        const newLog = s.scoreLog.filter((_, i) => i !== index);
        await updateDoc(doc(db, "students", currentStudentId), { scoreLog: newLog });
    };

    // [ìƒë‹´] ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ
    window.addCounselLog = async () => {
        const text = document.getElementById('newCounsel').value;
        if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        try {
            await updateDoc(doc(db, "students", currentStudentId), {
                counselLog: arrayUnion({ date: new Date().toLocaleDateString(), text: text })
            });
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('newCounsel').value = "";
        } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
    };
    window.editCounselLog = async (index) => {
        const s = allStudents.find(st => st.id === currentStudentId);
        const oldLog = s.counselLog[index];
        const newText = prompt("ìƒë‹´ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”:", oldLog.text);
        if (newText === null) return;
        const newLogs = [...s.counselLog];
        newLogs[index] = { date: oldLog.date, text: newText };
        await updateDoc(doc(db, "students", currentStudentId), { counselLog: newLogs });
    };
    window.deleteCounselLog = async (index) => {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const s = allStudents.find(st => st.id === currentStudentId);
        const newLogs = s.counselLog.filter((_, i) => i !== index);
        await updateDoc(doc(db, "students", currentStudentId), { counselLog: newLogs });
    };

    // [í•™ìƒ ì •ë³´] ìˆ˜ì •/ì‚­ì œ
    window.saveEdit = async () => {
        const id = document.getElementById('editId').value;
        if (!id) return;
        try {
            await updateDoc(doc(db, "students", id), {
                name: document.getElementById('editName').value,
                birth: document.getElementById('editBirth').value,
                gender: document.getElementById('editGender').value,
                school: document.getElementById('editSchool').value,
                belt: document.getElementById('editGrade').value,
                phone: document.getElementById('editParentPhone').value,
                studentPhone: document.getElementById('editStudentPhone').value,
                address: document.getElementById('editAddress').value,
                notes: document.getElementById('editNotes').value
            });
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
    };
    window.deleteStudent = async () => {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) {
            await deleteDoc(doc(db, "students", currentStudentId));
            window.closeModal();
        }
    };

    // =========================================================
    // 9. ìº˜ë¦°ë” ë° ì¼ì • ê´€ë¦¬
    // =========================================================
    let currentViewMode = 'day';

    window.renderCalendar = () => {
        const y = calDate.getFullYear(), m = calDate.getMonth();
        const calTitle = document.getElementById('calTitle');
        if(calTitle) calTitle.innerText = `${y}ë…„ ${m+1}ì›”`;
        
        const grid = document.getElementById('calGrid');
        if(!grid) return;
        grid.innerHTML = "";
        
        // ì¼ì • ë³‘í•© (ìƒì¼ + ìŠ¤ì¼€ì¤„)
        let events = [];
        if(document.getElementById('showSchedule')?.checked) events = [...events, ...allSchedules.map(s => ({...s, type:'schedule'}))];
        if(document.getElementById('showBirthday')?.checked) {
            allStudents.forEach(s => {
                if(s.birth && s.birth.includes(`-${String(m+1).padStart(2,'0')}-`)) 
                    events.push({date: `${y}-${s.birth.slice(5)}`, title: `${s.name} ìƒì¼`, type:'birthday'});
            });
        }

        // ë‹¬ë ¥ ê·¸ë¦¬ê¸°
        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
        for(let d=1; d<=last; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayEvents = events.filter(e => e.date === dateStr);
            const isToday = dateStr === new Date().toISOString().slice(0,10) ? 'today' : '';
            const isSelected = dateStr === selectedDateStr ? 'border: 2px solid var(--primary);' : '';
            
            let dots = "";
            dayEvents.forEach(e => { dots += `<span class="event-dot dot-${e.type}"></span>`; });

            grid.innerHTML += `
                <div class="day-cell ${isToday}" style="${isSelected}" onclick="clickDate('${dateStr}')">
                    <span class="day-num">${d}</span>
                    <div style="display:flex; gap:2px; justify-content:center; flex-wrap:wrap;">${dots}</div>
                </div>`;
        }
        updateScheduleList();
    };

   // [ìˆ˜ì •] ë‚ ì§œ í´ë¦­ ì‹œ ë°”ë¡œ íŒì—…ì„ ë„ì›Œ ì¼ì • ê´€ë¦¬ (ì„ ìƒë‹˜ ëª¨ë“œì¼ ë•Œë§Œ)
    window.clickDate = (date) => {
        selectedDateStr = date;
        renderCalendar(); // ì„ íƒ íš¨ê³¼ ê°±ì‹ 
        
        // ì„ ìƒë‹˜ ëª¨ë“œ(ê´€ë¦¬ì)ë¼ë©´ ì¦‰ì‹œ íŒì—… ì—´ê¸°
        if (document.body.classList.contains('show-admin')) {
            window.openScheduleModal('', '', date);
        } else {
            // í•™ë¶€ëª¨ ëª¨ë“œë¼ë©´ í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ë·°ë§Œ ê°±ì‹ 
            window.changeListView('day', document.querySelector('.view-mode-btn'));
        }
    };

    window.changeListView = (mode, btn) => {
        currentViewMode = mode;
        document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        updateScheduleList();
    };

    function updateScheduleList() {
        const date = selectedDateStr;
        const listArea = document.getElementById('dailyEventList');
        if(!listArea) return;
        
        // ë³´ê¸° ëª¨ë“œì— ë”°ë¥¸ ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
        let startDate = new Date(date);
        let endDate = new Date(date);
        let titleText = date + " ì¼ì •";

        if (currentViewMode === 'week') {
            const day = startDate.getDay(); 
            startDate.setDate(startDate.getDate() - day);
            endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6);
            titleText = "ì£¼ê°„ ì¼ì •";
        } else if (currentViewMode === 'month') {
            startDate.setDate(1);
            endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
            titleText = "ì›”ê°„ ì¼ì •";
        } else if (currentViewMode === 'year') {
            startDate = new Date(startDate.getFullYear(), 0, 1);
            endDate = new Date(startDate.getFullYear(), 11, 31);
            titleText = "ì—°ê°„ ì¼ì •";
        }

        if(document.getElementById('selectedDateText')) document.getElementById('selectedDateText').querySelector('span').innerText = titleText;
        if(document.getElementById('schedDate')) document.getElementById('schedDate').value = date;
        
        const isAdmin = document.body.classList.contains('show-admin');
        const addBtn = document.getElementById('addSchedBtn');
        if(addBtn) addBtn.style.display = isAdmin ? 'block' : 'none';

        // í•„í„°ë§
        let events = [];
        allSchedules.forEach(s => {
            if (s.date >= startDate.toISOString().slice(0,10) && s.date <= endDate.toISOString().slice(0,10)) events.push({ ...s, type: 'schedule' });
        });
        
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const mStr = String(d.getMonth() + 1).padStart(2, '0');
            const dStr = String(d.getDate()).padStart(2, '0');
            const checkDate = `-${mStr}-${dStr}`;
            allStudents.forEach(s => {
                if (s.birth && s.birth.includes(checkDate)) events.push({ date: d.toISOString().slice(0,10), title: `${s.name} ìƒì¼`, type: 'birthday' });
            });
        }
        events.sort((a, b) => a.date.localeCompare(b.date));

        if (events.length === 0) listArea.innerHTML = "<div style='color:#999; padding:15px; text-align:center;'>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        else {
            listArea.innerHTML = events.map(e => {
                const icon = e.type === 'birthday' ? 'ğŸ‚' : 'ğŸ“…';
                const isSched = e.type === 'schedule';
                const clickAction = (isSched && isAdmin) ? `onclick="openScheduleModal('${e.id}', '${e.title}', '${e.date}')"` : "";
                const dateTag = currentViewMode !== 'day' ? `<span style="font-size:11px; color:#666; margin-right:5px; background:#eee; padding:2px 5px; borderRadius:4px;">${e.date.slice(5)}</span>` : ""; 
                return `<div style="padding:8px; border-bottom:1px solid #eee; ${clickAction ? 'cursor:pointer' : ''}" ${clickAction}>
                    ${dateTag} ${icon} <strong>${e.title}</strong>
                </div>`;
            }).join('');
        }
    }

    window.changeCalDate = (n) => { calDate.setMonth(calDate.getMonth() + n); renderCalendar(); };
    // [ìˆ˜ì •] íŒì—… ì—´ ë•Œ í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì¡´ ì¼ì •ë„ ê°™ì´ ë³´ì—¬ì£¼ê¸°
    window.openScheduleModal = (id, title, date) => {
        const modal = document.getElementById('scheduleModal');
        modal.style.display = 'flex';
        
        // 1. ì…ë ¥ í¼ ì´ˆê¸°í™”
        document.getElementById('schedId').value = id || '';
        document.getElementById('schedTitle').value = title || '';
        document.getElementById('schedDate').value = date || selectedDateStr;
        
        // ì‚­ì œ ë²„íŠ¼ì€ ìˆ˜ì • ëª¨ë“œ(idê°€ ìˆì„ ë•Œ)ì¼ ë•Œë§Œ í‘œì‹œ
        document.getElementById('btnDelSched').style.display = id ? 'inline-block' : 'none';

        // 2. í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì¡´ ì¼ì • ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        const targetDate = date || selectedDateStr;
        const listArea = document.getElementById('popupSchedList');
        
        // í•´ë‹¹ ë‚ ì§œì˜ ìŠ¤ì¼€ì¤„ë§Œ í•„í„°ë§
        const dayEvents = allSchedules.filter(s => s.date === targetDate);
        
        if (dayEvents.length === 0) {
            listArea.innerHTML = "<div style='color:#999; text-align:center;'>ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        } else {
            listArea.innerHTML = dayEvents.map(e => `
                <div onclick="window.openScheduleModal('${e.id}', '${e.title}', '${e.date}')" 
                     style="padding:6px; border-bottom:1px solid #e2e8f0; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ“… ${e.title}</span>
                    <span style="font-size:11px; color:#3b82f6;">ìˆ˜ì • ></span>
                </div>
            `).join('');
        }
    };
    window.saveSchedule = async () => {
        const id = document.getElementById('schedId').value;
        const title = document.getElementById('schedTitle').value;
        const date = document.getElementById('schedDate').value;
        if(!title || !date) return alert("ì…ë ¥í•´ì£¼ì„¸ìš”");
        try {
            if(id) await updateDoc(doc(db, "schedules", id), { title, date });
            else await addDoc(collection(db, "schedules"), { title, date });
            document.getElementById('scheduleModal').style.display = 'none';
        } catch(e) { alert(e.message); }
    };
    window.deleteSchedule = async () => {
        if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await deleteDoc(doc(db, "schedules", document.getElementById('schedId').value));
            document.getElementById('scheduleModal').style.display = 'none';
        }
    };

    // =========================================================
    // 10. í‚¤ì˜¤ìŠ¤í¬ & ì¶œì„ ê¸°ëŠ¥ (ì¤‘ë³µ ì œê±° í›„ í†µí•©ë¨)
    // =========================================================
    window.startKioskMode = () => {
        if (confirm("ì¶œì„ë¶€ ëª¨ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.")) {
            document.body.classList.add('kiosk-mode');
            const chk = document.getElementById('adminToggle');
            if(chk) chk.checked = false;
            document.body.classList.remove('show-admin');
            filterList();
        }
    };
    window.exitKioskMode = () => {
        if (!document.body.classList.contains('kiosk-mode')) return;
        if (prompt("ë¹„ë°€ë²ˆí˜¸:") === "1234") { 
            document.body.classList.remove('kiosk-mode');
            alert("ì„ ìƒë‹˜ ëª¨ë“œë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.");
            filterList();
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜");
        }
    };
    window.setKioskCategory = (cat, btn) => {
        currentKioskCategory = cat;
        document.querySelectorAll('.k-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterList();
    };

    window.kioskTapAttendance = async (id) => {
        const s = allStudents.find(st => st.id === id);
        if(!s) return;
        const todayStr = new Date().toDateString();
        
        const hasArrived = (s.attendanceLog || []).some(log => {
            const d = log.toDate ? log.toDate() : new Date(log.seconds * 1000);
            return d.toDateString() === todayStr;
        });
        const hasLeft = (s.attendanceOutLog || []).some(log => {
            const d = log.toDate ? log.toDate() : new Date(log.seconds * 1000);
            return d.toDateString() === todayStr;
        });

        if(!hasArrived) window.quickAttendance(id, 'in');
        else if(!hasLeft) window.quickAttendance(id, 'out');
        else showToast("ì´ë¯¸ í•˜ì› ì™„ë£Œ ìƒíƒœì…ë‹ˆë‹¤ âœ…", "warn");
    };

    window.quickAttendance = async (id, type) => {
        const s = allStudents.find(st => st.id === id);
        if(!s) return;

        // ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ ë° ì¤‘ë³µ ë°©ì§€
        const card = document.getElementById(`card-${id}`);
        if(card) {
            if(card.dataset.busy === "1") return;
            card.dataset.busy = "1";
            setTimeout(()=>{ card.dataset.busy = "0"; }, 2000);
            
            card.classList.remove('card-anim-active');
            void card.offsetWidth;
            card.classList.add('card-anim-active');
        }

        playSuccessSound();
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if (type === 'in') {
            try { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); } catch(e){}
            speakText(`${s.name} ë“±ì› ì™„ë£Œ`);
            await updateDoc(doc(db, "students", id), { attendanceLog: arrayUnion(now) });
            if(s.phone) sendSmsByServer(s.phone.replace(/-/g,''), `[ë¯¸ë˜ì—”ìˆ˜í•™] ${s.name} í•™ìƒì´ ${timeStr}ì— ë“±ì›í–ˆìŠµë‹ˆë‹¤.`);
        } else {
            speakText(`${s.name} í•˜ì› ì™„ë£Œ`);
            await updateDoc(doc(db, "students", id), { attendanceOutLog: arrayUnion(now) });
            if(s.phone) sendSmsByServer(s.phone.replace(/-/g,''), `[ë¯¸ë˜ì—”ìˆ˜í•™] ${s.name} í•™ìƒì´ ${timeStr}ì— í•˜ì›í–ˆìŠµë‹ˆë‹¤.`);
        }
        
        filterList();
    };

    // =========================================================
    // 11. ê´€ë¦¬ì ìœ í‹¸ë¦¬í‹° (ì¼ê´„ì²˜ë¦¬, ë°±ì—…, ì—‘ì…€)
    // =========================================================
    
    // í˜ì´ì§€ ì „í™˜
    window.showPage = (id) => {
        if (document.body.classList.contains('kiosk-mode') && id !== 'list') return;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(id).classList.add('active');
        // íƒ­ ë²„íŠ¼ í™œì„±í™” ë¡œì§
        const idx = id === 'register' ? 0 : id === 'list' ? 1 : 2;
        const tabs = document.querySelectorAll('.tab-btn');
        if(tabs[idx]) tabs[idx].classList.add('active');
        
        if(id === 'calendar' && window.renderCalendar) window.renderCalendar();
    };

    // ì„ ìƒë‹˜ ëª¨ë“œ í† ê¸€
    window.toggleAdminMode = async () => {
        const chk = document.getElementById('adminToggle');
        const btnKiosk = document.getElementById('btnKioskStart');
        
        if(chk.checked) {
            let dbPw = "1234"; 
            try {
                const docSnap = await getDoc(doc(db, "settings", "admin"));
                if (docSnap.exists()) dbPw = docSnap.data().password;
            } catch(e) {}

            const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if(pw === dbPw) { 
                document.body.classList.add('show-admin');
                if(btnKiosk) btnKiosk.style.display = 'inline-block';
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                chk.checked = false;
            }
        } else {
            document.body.classList.remove('show-admin');
            if(btnKiosk) btnKiosk.style.display = 'none';
        }
    };

    // ì¼ê´„ ì²˜ë¦¬
    window.toggleSelection = (id, e) => {
        e.stopPropagation();
        if(selectedStudentIds.has(id)) selectedStudentIds.delete(id);
        else selectedStudentIds.add(id);
        updateBulkBtn();
    };
    window.toggleSelectAll = () => {
        const chk = document.getElementById('selectAll').checked;
        const visibleIds = Array.from(document.querySelectorAll('.list-chk')).map(el => el.value);
        if(chk) visibleIds.forEach(id => selectedStudentIds.add(id));
        else selectedStudentIds.clear();
        
        document.querySelectorAll('.list-chk').forEach(box => { box.checked = selectedStudentIds.has(box.value); });
        updateBulkBtn();
    };
    function updateBulkBtn() {
        const count = selectedStudentIds.size;
        document.getElementById('selectedCount').innerText = `${count}ëª… ì„ íƒë¨`;
        document.getElementById('bulkActionBtn').style.display = count > 0 ? 'block' : 'none';
    }
    window.processBulkAttendance = async () => {
        if(!confirm(`ì„ íƒí•œ ${selectedStudentIds.size}ëª…ì—ê²Œ ë“±ì› ë¬¸ìë¥¼ ë°œì†¡í•˜ê³  ì¶œì„ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const phones = [];
        const promises = [];
        selectedStudentIds.forEach(id => {
            const s = allStudents.find(st => st.id === id);
            if(s) {
                promises.push(updateDoc(doc(db, "students", id), { attendanceLog: arrayUnion(new Date()) }));
                if(s.phone) phones.push(s.phone.replace(/[^0-9]/g, ''));
            }
        });
        try {
            await Promise.all(promises);
            const msg = "[ë¯¸ë˜ì—”ìˆ˜í•™] ìë…€ê°€ êµì‹¤ì— ë„ì°©í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤.";
            const uniqPhones = [...new Set(phones)];
            let success = 0, fail = 0;
            for (const p of uniqPhones) {
                try {
                    const { ok } = await sendSmsByServer(p, msg);
                    if (ok) success++; else fail++;
                } catch(e) { fail++; }
            }
            alert(`ì²˜ë¦¬ ì™„ë£Œ (ì„±ê³µ: ${success}, ì‹¤íŒ¨: ${fail})`);
            selectedStudentIds.clear();
            document.getElementById('selectAll').checked = false;
            filterList();
            updateBulkBtn();
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    };

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° ë°±ì—…
    window.downloadExcel = () => {
        const data = allStudents.map((s, i) => ({ "No": i+1, "ì´ë¦„": s.name, "í•™êµ": s.school, "í•™ë…„": s.belt, "ë¶€ëª¨ë‹˜": s.phone }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ëª…ë‹¨");
        XLSX.writeFile(wb, `ì›ìƒëª…ë‹¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    };
    window.downloadBackup = () => {
        const blob = new Blob([JSON.stringify(allStudents)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = "backup.json"; a.click();
    };
    window.restoreData = (e) => {
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const data = JSON.parse(evt.target.result);
            if(confirm(`${data.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                for(const s of data) {
                    const { id, ...rest } = s; 
                    await addDoc(collection(db, "students"), { ...rest, regDate: serverTimestamp() });
                }
                alert("ë³µêµ¬ ì™„ë£Œ");
            }
        };
        reader.readAsText(e.target.files[0]);
    };
    window.changeAdminPassword = async () => {
        const newPw = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸:");
        if(newPw) {
            await setDoc(doc(db, "settings", "admin"), { password: newPw });
            alert("ë³€ê²½ë¨");
        }
    };

    // =========================================================
    // 12. ê¸°íƒ€ UI íš¨ê³¼ ë° ìœ í‹¸ë¦¬í‹°
    // =========================================================
    
    // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
    function resizeImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 300/img.width; 
                    canvas.width = 300; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
    window.triggerPhotoEdit = () => { if(document.body.classList.contains('show-admin')) document.getElementById('editPhotoInput').click(); };
    window.previewEditPhoto = async () => {
        const file = document.getElementById('editPhotoInput').files[0];
        if(file) document.getElementById('modalImg').src = await resizeImage(file);
    };

    // ì•Œë¦¼ì¥ ë° ì •ì‚° í…ìŠ¤íŠ¸
    // [ìˆ˜ì •ë¨] í•™ìŠµ ì•ˆë‚´ ì–‘ì‹ (ìƒì„¸í•˜ê³  ì¹œì ˆí•œ ë²„ì „)
    window.generateNotice = () => {
        const s = allStudents.find(st => st.id === currentStudentId);
        // ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
        const text = document.getElementById('dailyProgress').value;
        if(!text) {
            alert("í•™ìŠµ ë‚´ìš©ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return "";
        }

        const today = new Date();
        const dateStr = `${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;

        // ì´ëª¨ì§€ì™€ ì¤„ë°”ê¿ˆì„ í™œìš©í•œ ê°€ë…ì„± ë†’ì€ í…œí”Œë¦¿
        const msg = `[ë¯¸ë˜ì—”ìˆ˜í•™] ${dateStr} ì•Œë¦¼ì¥ ğŸ“¢\n\n` +
                    `ì•ˆë…•í•˜ì„¸ìš”, í•™ë¶€ëª¨ë‹˜!\n` +
                    `ì˜¤ëŠ˜ ${s.name} í•™ìƒì´ ê³µë¶€í•œ ë‚´ìš© ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.\n\n` +
                    `ğŸ“š **ì˜¤ëŠ˜ì˜ í•™ìŠµ**\n` +
                    `${text}\n\n` +
                    `ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ ê³µë¶€í•œ ${s.name}ì—ê²Œ\n` +
                    `ê°€ì •ì—ì„œë„ ë”°ëœ»í•œ ê²©ë ¤ì™€ ì¹­ì°¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n` +
                    `ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ˜Š`;

        document.getElementById('noticePreview').innerText = msg;
        return msg;
    };
    window.copyNotice = () => {
        const text = document.getElementById('noticePreview').innerText;
        navigator.clipboard.writeText(text).then(()=>alert("ë³µì‚¬ë¨"));
    };
    window.sendNoticeSms = () => {
        const s = allStudents.find(st => st.id === currentStudentId);
        if(!s || !s.phone) return alert("ì—°ë½ì²˜ ì—†ìŒ");
        const msg = window.generateNotice();
        location.href = `sms:${s.phone.replace(/-/g,'')}?body=${encodeURIComponent(msg)}`;
    };
    window.sendNoticeKakao = () => {
        if (window.Kakao && !Kakao.isInitialized()) Kakao.init('0a302951dba10cb82dbfc0b603784155'); 
        const msg = window.generateNotice();
        try {
            Kakao.Share.sendDefault({
                objectType: 'text', text: msg,
                link: { mobileWebUrl: 'https://map.naver.com', webUrl: 'https://map.naver.com' },
                buttonTitle: 'í•™ì›ì •ë³´'
            });
        } catch(e) { alert(e); }
    };
  // [ìˆ˜ì •ë¨] ì›”ë§ ì •ì‚°/êµìœ¡ë¹„ ì•ˆë‚´ ì–‘ì‹ (ìë™ ê³„ì‚° + ê³„ì¢Œ ì–‘ì‹ í¬í•¨)
    window.generateSettlement = () => {
        const s = allStudents.find(st => st.id === currentStudentId);
        const now = new Date();
        const currentMonth = now.getMonth() + 1; // ì´ë²ˆ ë‹¬
        
        // ë‹¤ìŒ ë‹¬ ê³„ì‚° (12ì›”ì´ë©´ ë‚´ë…„ 1ì›”ë¡œ í‘œì‹œ)
        const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;

        // ì´ë²ˆ ë‹¬ ì¶œì„ íšŸìˆ˜ ì •í™•íˆ ê³„ì‚°
        const logs = (s.attendanceLog || []).filter(ts => {
            const d = ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });

        // ì •ì‚° ì•ˆë‚´ í…œí”Œë¦¿
        const msg = `[ë¯¸ë˜ì—”ìˆ˜í•™] ${nextMonth}ì›” êµìœ¡ë¹„ ì•ˆë‚´ ğŸ“„\n\n` +
                    `ì•ˆë…•í•˜ì„¸ìš”, í•™ë¶€ëª¨ë‹˜.\n` +
                    `ì–´ëŠë§ ${currentMonth}ì›” í•™ìŠµì„ ì˜ ë§ˆë¬´ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n` +
                    `âœ… **${currentMonth}ì›” ì¶œì„ í˜„í™©**\n` +
                    `- ì´ ë“±ì›ì¼: ${logs.length}íšŒ\n\n` +
                    `ì„±ì‹¤í•˜ê²Œ í•™ìŠµí•œ ${s.name} í•™ìƒì—ê²Œ ë§ì€ ì¹­ì°¬ ë¶€íƒë“œë¦¬ë©°,\n` +
                    `ë‹¤ìŒ ë‹¬ êµìœ¡ë¹„ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.\n\n` +
                    `ğŸ’° **ë‚©ë¶€ ì•ˆë‚´**\n` +
                    `- ê¸°ê°„: ${nextMonth}ì›” 1ì¼ ~ ${nextMonth}ì›” 10ì¼\n` +
                    `- ê³„ì¢Œ: ë†í˜‘ 000-0000-0000 (ì˜ˆê¸ˆì£¼:í™ê¸¸ë™)\n` + 
                    `- ê¸ˆì•¡: (ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”)\n\n` +
                    `ëŠ˜ ë¯¿ê³  ë§¡ê²¨ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.`;

        document.getElementById('settlementPreview').innerText = msg;
    };
    window.copyText = (id) => { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("ë³µì‚¬ë¨"); };

    // ì¶œì„ í†µê³„ ê³„ì‚°
    window.calcStats = (s) => {
        const logs = s.attendanceLog || [];
        const total = logs.length;
        const now = new Date();
        const thisMonthLogs = logs.filter(ts => {
            const d = ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000);
            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
        if(document.getElementById('statTotal')) document.getElementById('statTotal').innerText = `${total}íšŒ`;
        if(document.getElementById('statMonth')) {
             document.getElementById('statMonth').innerText = `${thisMonthLogs.length}íšŒ`;
             const label = document.getElementById('statMonth').nextElementSibling;
             if(label) label.innerText = "ì´ë²ˆë‹¬ ë“±ì›";
        }
    };

    // UI í”¼ë“œë°± (Toast, Sound, TTS)
    function showToast(msg, type) {
        const t = document.getElementById('toast');
        if(t) {
            t.innerHTML = `<span class="dot"></span> ${msg}`; 
            t.className = `toast show ${type||''}`;
            setTimeout(()=>t.classList.remove('show'), 2000);
        }
    }
    function speakText(txt) {
        if(!window.speechSynthesis) return;
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'ko-KR'; window.speechSynthesis.speak(u);
    }
    function playSuccessSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        osc.frequency.setValueAtTime(600, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    }

    // ëª¨ë‹¬ íƒ­ ì „í™˜
    window.switchModalTab = (id, btn) => {
        document.querySelectorAll('.modal-tab-pane').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.modal-tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    };
    
    // ëª¨ë‹¬ ë‹«ê¸° ìœ í‹¸
    window.closeModal = () => { document.getElementById('detailModal').style.display = 'none'; currentStudentId = null; };
    window.onclick = (e) => {
        if(e.target == document.getElementById('detailModal')) window.closeModal();
        if(e.target == document.getElementById('scheduleModal')) document.getElementById('scheduleModal').style.display = "none";
    };

    // ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = () => {
        if(localStorage.getItem('isKioskMode')==='true') document.body.classList.add('kiosk-mode');
    };
</script>




<div id="toast" class="toast" aria-live="polite" aria-atomic="true">
    <span class="dot"></span><span id="toastText"></span>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal" style="max-width:340px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <h3 style="margin:0;">âš™ï¸ ê´€ë¦¬ì ì„¤ì •</h3>
            <button onclick="document.getElementById('settingsModal').style.display='none'" style="border:none; background:none; font-size:20px;">&times;</button>
        </div>
        
        <div style="display:grid; gap:10px;">
            <button class="action-btn" onclick="startKioskMode()" style="background:#fffbeb; color:#b45309; border:1px solid #fcd34d; box-shadow:none;">
                <i class="fas fa-tablet-alt"></i> ì¶œì„ë¶€ ëª¨ë“œ ì‹œì‘
            </button>
            <button class="action-btn" onclick="downloadExcel()" style="background:#f0fdf4; color:#15803d; border:1px solid #86efac; box-shadow:none;">
                <i class="fas fa-file-excel"></i> ì—‘ì…€ ëª…ë‹¨ ì €ì¥
            </button>
            <button class="action-btn" onclick="downloadBackup()" style="background:#eff6ff; color:#1d4ed8; border:1px solid #93c5fd; box-shadow:none;">
                <i class="fas fa-download"></i> ë°ì´í„° ë°±ì—… (JSON)
            </button>
            <button class="action-btn" onclick="document.getElementById('restoreInput').click()" style="background:#faf5ff; color:#7e22ce; border:1px solid #d8b4fe; box-shadow:none;">
                <i class="fas fa-upload"></i> ë°ì´í„° ë³µêµ¬
            </button>
            <button class="action-btn" onclick="changeAdminPassword()" style="background:#fff1f2; color:#be123c; border:1px solid #fda4af; box-shadow:none;">
                <i class="fas fa-key"></i> ê´€ë¦¬ì ë¹„ë²ˆ ë³€ê²½
            </button>
        </div>
        <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreData(event)">
    </div>
</div>
</body>
</html>
