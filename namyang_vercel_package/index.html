<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„ êµì‹¤ ê´€ë¦¬</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#009688">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* [ë””ìì¸] ìˆ˜í•™/í•™ì› í…Œë§ˆ (Teal & Clean White) */
        :root { 
          --primary: #2563eb;        /* ì‹ ë¢°ê° ìˆëŠ” ë¸”ë£¨ */
          --primary-dark: #1e40af;
          --secondary: #eef2ff;
          --accent: #f59e0b;         /* í¬ì¸íŠ¸ (ì£¼ì˜/ê°•ì¡°) */
          --danger: #ef4444;
        
          --bg: #f8fafc;             /* ì „ì²´ ë°°ê²½ */
          --white: #ffffff;
        
          --text-main: #0f172a;      /* ë³¸ë¬¸ */
          --text-sub: #475569;       /* ë³´ì¡° í…ìŠ¤íŠ¸ */
        }

        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; padding: 15px; -webkit-font-smoothing: antialiased; }
        
        .container { max-width: 800px; margin: 0 auto; background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--bg);
        }
        h1 { margin: 0; font-size: 22px; font-weight: 700; color: var(--primary-dark); display: flex; align-items: center; gap: 8px; }
        .admin-switch { display: flex; align-items: center; font-size: 13px; color: var(--text-sub); background: var(--bg); padding: 5px 12px; border-radius: 20px; }
        
        /* íƒ­ ë²„íŠ¼ */
        .tabs { display: flex; margin-bottom: 25px; background: #eceff1; border-radius: 12px; padding: 5px; gap: 5px; }
        .tab-btn { flex: 1; background: none; border: none; padding: 12px; font-size: 15px; cursor: pointer; color: #78909c; font-weight: 600; border-radius: 10px; transition: 0.2s; }
        .tab-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ì…ë ¥ í¼ */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #cfd8dc; border-radius: 10px; box-sizing: border-box; font-size: 14px; 
            transition: 0.2s; background: #fafafa; font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(0,150,136,0.1); }
        label { font-size: 13px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; display: block; }
        
        button.action-btn { 
            width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 16px; margin-top: 15px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,150,136,0.2); transition: 0.2s;
        }
        button.action-btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        button.action-btn:disabled { background-color: #b0bec5 !important; cursor: not-allowed; opacity: 0.8; box-shadow: none; transform: none; }
        
        /* í•„í„° ë° íˆ´ë°” */
        .filter-container { background: #f1f8e9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #c5e1a5; }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .filter-label { font-size: 13px; font-weight: bold; color: #33691e; width: 60px; }
        
        .filter-group { display: flex; gap: 6px; flex-wrap: wrap; flex: 1; }
        .filter-chip { 
            padding: 6px 14px; border-radius: 20px; border: 1px solid transparent; background: white; 
            font-size: 13px; cursor: pointer; color: #558b2f; transition: 0.2s; font-weight: 500;
        }
        .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,150,136,0.3); }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .student-card { 
            background: #fff; border: 1px solid #eceff1; padding: 15px; margin-bottom: 12px; border-radius: 12px; 
            display: flex; gap: 15px; align-items: center; cursor: pointer; transition: 0.2s; position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .student-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .chk-wrapper { display: flex; align-items: center; width: 30px; }
        .list-chk { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }

        .profile-wrapper { width: 55px; height: 55px; flex-shrink: 0; }
        .profile-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .info-area { flex: 1; overflow: hidden; }
        .grade-tag { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; color: white; margin-left: 5px; background: #78909c; vertical-align: middle; }
        
        /* ìº˜ë¦°ë” */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: var(--secondary); padding: 10px; border-radius: 10px; }
        .cal-btn { background: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--primary-dark); font-weight: bold; }
        .current-date { font-size: 18px; font-weight: 800; color: var(--primary-dark); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .day-name { text-align: center; font-weight: bold; font-size: 12px; padding: 8px; color: var(--text-sub); }
       
        .day-cell { 
            min-height: 30px; /* ë†’ì´ ì¤„ì„ */
            border: 1px solid #eee; border-radius: 6px; padding: 2px; 
            position: relative; cursor: pointer; background: white; transition: 0.2s; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        }
        .day-num { font-weight: bold; font-size: 11px; margin-bottom: 0; }
        .event-dot { width: 4px; height: 4px; border-radius: 50%; margin: 1px; }

        /* [ì¶”ê°€] ë¦¬ìŠ¤íŠ¸ ë³´ê¸° ëª¨ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .view-mode-group { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; }
        .view-mode-btn { 
            padding: 6px 12px; border: 1px solid #ddd; background: white; 
            border-radius: 20px; font-size: 12px; cursor: pointer; color: #555; font-weight: bold;
        }
        .view-mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* [ìˆ˜ì •] ì¼ì • ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë””ìì¸ */
        .daily-event-item { 
            padding: 8px 12px; border-radius: 8px; border: 1px solid #eee; background: #fff;
            margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; 
            font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .event-date-tag { font-size: 11px; color: #888; margin-right: 8px; font-weight: normal; }

        /* íŒì—… ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .modal-btn-group { display: flex; gap: 10px; margin-top: 15px; }      
        .event-birthday { background-color: #f06292; } 
        .event-schedule { background-color: var(--primary); } 
        .event-holiday { background-color: var(--danger); }

        /* ëª¨ë‹¬ (íŒì—…) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; background: none; border: none; color: #90a4ae; }
        
        .stat-box { display: flex; gap: 10px; margin: 20px 0; background: #f5f7f9; padding: 15px; border-radius: 12px; }
        .stat-item { flex: 1; text-align: center; }
        .stat-num { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 4px; }
        
        .log-item { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #eee; font-size: 13px; }
        
        /* ê´€ë¦¬ì ê¸°ëŠ¥ */
        .admin-only { display: none !important; }
        body.show-admin .admin-only { display: inline-block !important; } 
        body.show-admin .log-actions { display: flex; gap: 5px; margin-top: 5px; } 
        body.show-admin .admin-toolbar { display: flex !important; }
        
        .admin-toolbar { display: none; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: flex-end; }
        .admin-tool-btn { background: #fff; border: 1px solid var(--text-sub); color: var(--text-sub); padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; }

        /* ì¸ì‡„ìš© */
        #printArea { position: fixed; top: -9999px; left: -9999px; width: 210mm; background: white; padding: 10mm; font-family: 'Noto Sans KR', sans-serif; }
        .print-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 20px; }
        .print-table th, .print-table td { border: 1px solid #333; padding: 6px; text-align: center; }
        .print-table th { background: #eee; }
        
        /* ë‹¬ë ¥ ì¹¸ ìŠ¤íƒ€ì¼ ìˆ˜ì •: í…ìŠ¤íŠ¸ê°€ ë„˜ì¹˜ì§€ ì•Šê²Œ */
        .event-dot { 
            display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin: 1px; 
        }
        .dot-schedule { background-color: var(--primary); }
        .dot-birthday { background-color: #f06292; }

        /* ë‹¬ë ¥ í•˜ë‹¨ ì¼ì • ë¦¬ìŠ¤íŠ¸ ë””ìì¸ */
        #dateDetailArea {
            margin-top: 20px; padding: 15px; background: #fff; border-radius: 12px;
            border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .detail-header { 
            font-weight: 800; font-size: 15px; color: var(--primary-dark); 
            margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;
        }
        .daily-event-item {
            display: flex; align-items: center; gap: 8px; font-size: 14px; padding: 6px 0;
        }
        .daily-event-item i { width: 15px; text-align: center; }
        /* ì„±ì  ê·¸ë˜í”„ ì»¨í…Œì´ë„ˆ */
        .chart-container { margin: 20px 0; padding: 15px; background: #fff; border-radius: 12px; border: 1px solid #eee; }
        .score-input-group { display: flex; gap: 5px; margin-bottom: 10px; }

        /* ì›”ë§ ì •ì‚° ì•Œë¦¼ ì„¹ì…˜ */
        .settlement-box { background: #e3f2fd; border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #bbdefb; }
        .settlement-title { font-weight: bold; color: #1565c0; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        
        /* [ëª¨ë°”ì¼ ìµœì í™”] ë¦¬ìŠ¤íŠ¸ ì˜ì—­ì„ ë°”ë‘‘íŒ(Grid)ìœ¼ë¡œ ë³€ê²½ */
        #studentListArea {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* ì¹´ë“œ ë„ˆë¹„ ìë™ ì¡°ì ˆ */
            gap: 10px; /* ì¹´ë“œ ì‚¬ì´ ê°„ê²© */
            padding: 5px;
        }

        /* í•™ìƒ ì¹´ë“œ ë””ìì¸ (ë„¤ëª¨ë‚œ IDì¹´ë“œ ìŠ¤íƒ€ì¼) */
        .student-card { 
            background: #fff; border: 1px solid #eceff1; border-radius: 15px; 
            padding: 15px 10px; 
            display: flex; flex-direction: column; /* ìœ„ì•„ë˜ë¡œ ì •ë ¬ */
            align-items: center; justify-content: center; text-align: center;
            cursor: pointer; transition: 0.2s; position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 160px; /* ì¹´ë“œ ë†’ì´ ê³ ì • */
        }
        .student-card:active { transform: scale(0.98); } /* í´ë¦­ ì‹œ ëˆŒë¦¬ëŠ” íš¨ê³¼ */

        /* ì²´í¬ë°•ìŠ¤ ìœ„ì¹˜ (ì™¼ìª½ ìœ„) */
        .chk-wrapper { position: absolute; top: 8px; left: 8px; z-index: 10; }

        /* í”„ë¡œí•„ ì‚¬ì§„ í¬ê¸° ì¡°ì • */
        .profile-wrapper { width: 60px; height: 60px; margin-bottom: 8px; }
        .profile-img { box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid white; }

        /* í…ìŠ¤íŠ¸ ì •ë¦¬ */
        .info-area { padding-left: 0 !important; width: 100%; }
        .info-area div:first-child { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .info-area small { display: block; font-size: 11px; color: #888; margin-bottom: 4px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .grade-tag { font-size: 10px; padding: 2px 6px; }    

        /* [ì¶”ê°€] ëª¨ë‹¬ ë‚´ë¶€ íƒ­ ë””ìì¸ */
        .modal-header-profile { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .modal-tab-nav { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #f5f5f5; }
        .modal-tab-btn { 
            flex: 1; padding: 10px 5px; background: none; border: none; font-size: 14px; 
            font-weight: 600; color: #90a4ae; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; 
        }
        .modal-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .modal-tab-pane { display: none; animation: fadeIn 0.3s ease; }
        .modal-tab-pane.active { display: block; }

        /* ì‘ì€ í™”ë©´ì—ì„œ ë²„íŠ¼ë“¤ì´ ê½‰ ì°¨ê²Œ ë³´ì´ë„ë¡ ì¡°ì • */
        .modal-action-row { display: flex; gap: 8px; margin-top: 10px; }
        .modal-action-row button { flex: 1; margin: 0 !important; font-size: 13px; padding: 10px 0; }
        button {
        min-height: 44px;   /* iOS ê¶Œì¥ í„°ì¹˜ ì˜ì—­ */
        }
        .student-card,
        .modal,
        .container {
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        }
        .info-area strong {
        font-weight: 700;
        }

        .info-area small {
        color: var(--text-sub);
        }

        /* ===== ì¶œì„ë¶€(í‚¤ì˜¤ìŠ¤í¬) ëª¨ë“œ + í† ìŠ¤íŠ¸ ===== */
        :root{ --kiosk-green:#16a34a; --kiosk-amber:#f59e0b; }

        .toast{
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%) translateY(20px);
        background: rgba(20,20,20,.92);
        color:#fff;
        padding: 12px 14px;
        border-radius: 14px;
        box-shadow: 0 10px 30px rgba(0,0,0,.25);
        font-size: 14px;
        line-height: 1.3;
        opacity: 0;
        pointer-events: none;
        transition: opacity .18s ease, transform .18s ease;
        z-index: 9999;
        max-width: calc(100vw - 28px);
        display:flex;
        gap:10px;
        align-items:center;
        }
        .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
        .toast .dot{
        width:10px; height:10px; border-radius:999px; background:#22c55e;
        flex:0 0 auto;
        }
        .toast.error .dot{ background:#ef4444; }
        .toast.warn .dot{ background:#f59e0b; }

        /* ë²„íŠ¼ ì „ì†¡ ì• ë‹ˆë©”ì´ì…˜ */
        .btn-sending{ position: relative; overflow:hidden; }
        .btn-sending::after{
        content:"";
        position:absolute; inset:0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
        transform: translateX(-100%);
        animation: shimmer 1.2s infinite;
        }
        @keyframes shimmer{ 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }

        /* í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ: ë‹¤ë¥¸ í™”ë©´/íƒ­ ì ê¸ˆ */
        body.kiosk-mode .tabs{ display:none !important; }
        body.kiosk-mode .page{ display:none !important; }
        body.kiosk-mode #list.page{ display:block !important; }
        body.kiosk-mode #register,
        body.kiosk-mode #calendar{ display:none !important; }

        /* í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ: í•™ìƒ ì¹´ë“œ í´ë¦­(ìƒì„¸ë³´ê¸°) ë°©ì§€ */
        body.kiosk-mode .student-card{ cursor: default !important; }
/* === [ìˆ˜ì •] íƒœë¸”ë¦¿/í‚¤ì˜¤ìŠ¤í¬(ì¶œì„ë¶€) ì „ìš© ë©”íƒˆë¦­ 3D ìŠ¤íƒ€ì¼ === */
/* === [ìˆ˜ì •] íƒœë¸”ë¦¿/í‚¤ì˜¤ìŠ¤í¬(ì¶œì„ë¶€) ì „ìš© ë©”íƒˆë¦­ 3D ìŠ¤íƒ€ì¼ === */
body.kiosk-mode header, 
body.kiosk-mode .tabs, 
body.kiosk-mode .admin-only, 
body.kiosk-mode .calendar-controls,
body.kiosk-mode .filter-group { display: none !important; }

body.kiosk-mode #register, 
body.kiosk-mode #calendar { display: none !important; }
body.kiosk-mode #list { display: block !important; }

body.kiosk-mode { background: #1c1c1c; }

body.kiosk-mode #studentListArea {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 30px;
    padding: 30px;
}

/* [í•µì‹¬] 3D ë©”íƒˆ ì¹´ë“œ */
body.kiosk-mode .student-card {
    display: flex; 
    flex-direction: column;
    align-items: center; 
    justify-content: flex-start; /* ìœ„ì—ì„œë¶€í„° ì •ë ¬ */
    height: 380px; /* ë¼ë²¨ ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ ë†’ì´ ì•½ê°„ ì¦ê°€ */
    
    background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
    border: 3px solid transparent;
    border-image: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c) 1;
    /* fallback */
    border: 2px solid #c5a059;
    border-bottom: 8px solid #8a6e3d;
    
    border-radius: 20px;
    padding: 30px 20px; /* ë‚´ë¶€ ì—¬ë°± ì¡°ì • */
    
    box-shadow: inset 0 0 20px rgba(255,255,255,0.05), 0 20px 40px rgba(0,0,0,0.6);
    transition: transform 0.15s;
    position: relative;
    overflow: hidden;
}

/* ì¹´ë“œ í´ë¦­ ì• ë‹ˆë©”ì´ì…˜ (ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ í´ë˜ìŠ¤ ì¶”ê°€ë¨) */
@keyframes card-bump {
    0% { transform: scale(1); }
    40% { transform: scale(0.97) translateY(5px); }
    80% { transform: scale(1.02) translateY(-2px); }
    100% { transform: scale(1); }
}
.card-anim-active {
    animation: card-bump 0.4s ease-out;
}

/* ë“±ì› ì™„ë£Œ ì‹œ ìŠ¤íƒ€ì¼ */
body.kiosk-mode .student-card.arrived {
    background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);
    border-color: #a8ff78;
    border-bottom-color: #006400;
}

/* ì‚¬ì§„ í”„ë ˆì„ */
body.kiosk-mode .profile-wrapper {
    width: 140px; 
    height: 140px; 
    flex-shrink: 0; /* í¬ê¸° ê³ ì • */
    background: #000;
    padding: 4px;
    border-radius: 20px;
    box-shadow: 0 0 0 2px #c5a059, 0 10px 20px rgba(0,0,0,0.5);
    margin-bottom: 20px;
    z-index: 2; /* í…ìŠ¤íŠ¸ë³´ë‹¤ ìœ„ì— */
}

body.kiosk-mode .profile-img { 
    width: 100%; height: 100%; object-fit: cover; 
    border-radius: 16px; filter: brightness(1.05);
}

/* í…ìŠ¤íŠ¸ ì˜ì—­ */
body.kiosk-mode .info-area {
    text-align: center;
    width: 100%;
    margin-bottom: 20px;
}
body.kiosk-mode .info-area div:first-child { 
    font-size: 28px !important;
    font-weight: 800; 
    background: linear-gradient(to bottom, #fff 0%, #ccc 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    margin-bottom: 5px;
}
body.kiosk-mode .info-area small { 
    font-size: 14px; color: #e2b170 !important; font-weight: 600; letter-spacing: -0.5px;
}

/* ë²„íŠ¼ ê·¸ë£¹ */
body.kiosk-mode .kiosk-btn-group { 
    display: flex; width: 100%; gap: 10px; margin-top: auto; /* í•˜ë‹¨ìœ¼ë¡œ ë°€ê¸° */
    margin-bottom: 25px; /* ë¼ë²¨ ê³µê°„ */
    z-index: 10;
}
body.kiosk-mode .chk-wrapper { display: none; }

.k-btn {
    flex: 1; padding: 14px 0; border: none; border-radius: 10px;
    font-size: 16px; font-weight: 800; cursor: pointer; color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3); transition: all 0.2s;
}

.k-btn-in { 
    background: linear-gradient(to bottom, #edc988 0%, #d4af37 50%, #997f2e 100%);
    color: #3e2723; box-shadow: 0 4px 0 #6d4c41, 0 5px 10px rgba(0,0,0,0.3);
}
.k-btn-out { 
    background: linear-gradient(to bottom, #f2f6f8 0%, #d8e1e7 50%, #b5c6d0 100%);
    color: #37474f; box-shadow: 0 4px 0 #546e7a, 0 5px 10px rgba(0,0,0,0.3);
}
.k-btn:active { transform: translateY(4px); box-shadow: none !important; }

/* [ìˆ˜ì •] ë¹„í™œì„±í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ëˆ„ë¥¸ í›„) */
.k-btn:disabled {
    background: #444 !important;
    color: #888 !important;
    box-shadow: none !important;
    cursor: not-allowed;
    transform: translateY(2px);
    opacity: 0.7;
}

/* [ìˆ˜ì •] ì¹´ë“œ ë¼ë²¨ (í•˜ë‹¨ ì¤‘ì•™ ë°°ì¹˜) */
.card-label {
    position: absolute;
    bottom: 12px;
    width: 100%;
    text-align: center;
    font-size: 10px;
    color: rgba(255,255,255,0.2);
    letter-spacing: 3px;
    font-weight: bold;
    pointer-events: none;
}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fas fa-graduation-cap"></i> ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„</h1>
        
        <div class="admin-switch">
    <label style="margin:0; cursor:pointer; font-weight:normal; margin-right:10px;">
        <input type="checkbox" id="adminToggle" onclick="toggleAdminMode()" style="width:auto; margin-right:5px;"> ì„ ìƒë‹˜ ëª¨ë“œ
    </label>
    <button id="btnKioskStart" onclick="startKioskMode()" style="display:none; padding:5px 10px; background:#333; color:white; border:none; border-radius:5px; font-size:12px;">
        <i class="fas fa-tablet-alt"></i> ì¶œì„ë¶€ ëª¨ë“œ ì‹œì‘
    </button>
</div>

    </header>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="showPage('register')"><i class="fas fa-user-plus"></i> ì‹ ê·œ ë“±ë¡</button>
        <button class="tab-btn" onclick="showPage('list')"><i class="fas fa-users"></i> ì›ìƒ ê´€ë¦¬</button>
        <button class="tab-btn" onclick="showPage('calendar')"><i class="fas fa-calendar-alt"></i> í•™ìŠµ ì¼ì •</button>
    </div>

    <div id="register" class="page active">
        <div class="form-grid">
            <div class="full-width">
                <label>í•™ìƒ ì‚¬ì§„</label>
                <input type="file" id="regPhoto" accept="image/*">
            </div>
            <div>
                <label>ì´ë¦„</label>
                <input type="text" id="regName" placeholder="ì˜ˆ: ê¹€ìˆ˜í•™">
            </div>
            <div>
                <label>ìƒë…„ì›”ì¼</label>
                <input type="date" id="regBirth">
            </div>
            <div>
                <label>ì„±ë³„</label>
                <select id="regGender">
                    <option value="ë‚¨">ë‚¨ì</option>
                    <option value="ì—¬">ì—¬ì</option>
                </select>
            </div>
            <div>
                <label>í•™êµ</label>
                <input type="text" id="regSchool" placeholder="ì˜ˆ: ëŠ¥ë™ì´ˆ">
            </div>
            <div>
                <label>í•™ë…„/ê³¼ì •</label>
                <select id="regGrade">
                    <option value="ë¯¸ì·¨í•™">ë¯¸ì·¨í•™</option>
                    <option value="ì´ˆë“±1-2">ì´ˆë“± 1~2í•™ë…„</option>
                    <option value="ì´ˆë“±3-4">ì´ˆë“± 3~4í•™ë…„</option>
                    <option value="ì´ˆë“±5-6">ì´ˆë“± 5~6í•™ë…„</option>
                    <option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option>
                    <option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option>
                </select>
            </div>
            <div class="full-width" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="color:var(--primary);">í•™ë¶€ëª¨ ì—°ë½ì²˜ (ì•Œë¦¼ìš©)</label>
                    <input type="tel" id="regParentPhone" placeholder="01012345678">
                </div>
                <div>
                    <label>í•™ìƒ ë³¸ì¸ ì—°ë½ì²˜</label>
                    <input type="tel" id="regStudentPhone" placeholder="01012345678">
                </div>
            </div>
            <div class="full-width">
                <label>ì£¼ì†Œ</label>
                <input type="text" id="regAddress" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="full-width">
                <label>í•™ìŠµ íŠ¹ì´ì‚¬í•­ (ì§„ë„, ì„±í–¥ ë“±)</label>
                <textarea id="regNotes" rows="3" placeholder="ìƒë‹´ ë° ì§€ë„ ì‹œ ì°¸ê³ í•  ì‚¬í•­"></textarea>
            </div>
        </div>
        <button class="action-btn" id="addBtn">í•™ìƒ ë“±ë¡í•˜ê¸°</button>
    </div>

    <div id="list" class="page">
        <div class="admin-toolbar">
            <button class="admin-tool-btn" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> ì—‘ì…€ ì €ì¥</button>
            <button class="admin-tool-btn" onclick="downloadBackup()"><i class="fas fa-download"></i> ë°±ì—…(JSON)</button>
            <button class="admin-tool-btn" onclick="document.getElementById('restoreInput').click()"><i class="fas fa-upload"></i> ë³µêµ¬</button>
            <button class="admin-tool-btn" onclick="changeAdminPassword()"><i class="fas fa-key"></i> ë¹„ë²ˆ ë³€ê²½</button>
            <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="restoreData(event)">
        </div>

        <div class="filter-container">
            <div class="filter-row">
                <span class="filter-label">ê³¼ì •</span>
                <div class="filter-group" id="ageFilterGroup">
                    <div class="filter-chip active" onclick="setGradeFilter('all', this)">ì „ì²´</div>
                    <div class="filter-chip" onclick="setGradeFilter('ë¯¸ì·¨í•™', this)">ë¯¸ì·¨í•™</div>
                    <div class="filter-chip" onclick="setGradeFilter('ì´ˆë“±', this)">ì´ˆë“±ë¶€</div>
                    <div class="filter-chip" onclick="setGradeFilter('ì¤‘ë“±', this)">ì¤‘ë“±ë¶€</div>
                    <div class="filter-chip" onclick="setGradeFilter('ê³ ë“±', this)">ê³ ë“±ë¶€</div>
                </div>
            </div>
            <div class="filter-row">
                <span class="filter-label">ê²€ìƒ‰</span>
                <input type="text" id="searchKeyword" placeholder="ì´ë¦„ ê²€ìƒ‰" onkeyup="filterList()" style="flex:1;">
                <select id="schoolFilter" onchange="filterList()" style="width: auto; flex:1;">
                    <option value="all">ì „ì²´ í•™êµ</option>
                </select>
            </div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <input type="checkbox" id="selectAll" onclick="toggleSelectAll()">
                <label for="selectAll" style="font-size:14px;">ì „ì²´ ì„ íƒ</label>
            </div>
            <span id="selectedCount" style="font-size:13px; font-weight:bold; color:var(--primary);">0ëª… ì„ íƒë¨</span>
        </div>

        <button class="action-btn" id="bulkActionBtn" onclick="processBulkAttendance()" style="display:none; margin-top:0; margin-bottom:15px; background:var(--primary-dark);">
            <i class="fas fa-check-circle"></i> ì„ íƒ ì¸ì› ì¼ê´„ ë“±ì› ë¬¸ì ë°œì†¡
        </button>

        <div id="studentListArea">ë¡œë”©ì¤‘...</div>
    </div>

<div id="calendar" class="page">
    <div class="calendar-controls">
        <button class="cal-btn" onclick="changeCalDate(-1)"><i class="fas fa-chevron-left"></i></button>
        <div class="current-date" id="calTitle"></div>
        <button class="cal-btn" onclick="changeCalDate(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="filter-group" style="justify-content:center; margin-bottom:10px;">
        <label><input type="checkbox" id="showSchedule" checked onchange="renderCalendar()"> í•™ì›ì¼ì •</label> &nbsp;
        <label><input type="checkbox" id="showBirthday" checked onchange="renderCalendar()"> ìƒì¼</label>
    </div>

    <div class="calendar-grid">
        <div class="day-name" style="color:var(--danger)">ì¼</div><div class="day-name">ì›”</div><div class="day-name">í™”</div>
        <div class="day-name">ìˆ˜</div><div class="day-name">ëª©</div><div class="day-name">ê¸ˆ</div><div class="day-name" style="color:var(--primary)">í† </div>
    </div>
    <div class="calendar-grid" id="calGrid"></div>
    
<div id="dateDetailArea" style="margin-top:20px;">
        <div class="view-mode-group">
            <button class="view-mode-btn active" onclick="changeListView('day', this)">ì¼ê°„</button>
            <button class="view-mode-btn" onclick="changeListView('week', this)">ì£¼ê°„</button>
            <button class="view-mode-btn" onclick="changeListView('month', this)">ì›”ê°„</button>
            <button class="view-mode-btn" onclick="changeListView('year', this)">ì—°ê°„</button>
        </div>

        <h3 id="selectedDateText" style="font-size:15px; margin-bottom:10px; border-bottom:2px solid var(--primary); padding-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
            <span>ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            <button class="action-btn admin-only" id="addSchedBtn" onclick="openScheduleModal()" style="width:auto; margin:0; padding:5px 10px; font-size:12px; display:none;">+ ì¼ì • ë“±ë¡</button>
        </h3>
        
        <div id="dailyEventList" style="max-height:300px; overflow-y:auto;"></div>
    </div>
</div>

<div class="modal-overlay" id="scheduleModal">
    <div class="modal" style="max-width:320px;">
        <h3 id="schedModalTitle" style="margin-top:0;">ì¼ì • ê´€ë¦¬</h3>
        
        <input type="hidden" id="schedId"> <label>ë‚ ì§œ</label>
        <input type="date" id="schedDate" style="margin-bottom:10px;">
        
        <label>ë‚´ìš©</label>
        <input type="text" id="schedTitle" placeholder="ì¼ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:15px;">
        
        <div class="modal-btn-group">
            <button class="action-btn" onclick="saveSchedule()" style="margin:0; flex:1;">ì €ì¥</button>
            <button class="action-btn" onclick="deleteSchedule()" id="btnDelSched" style="margin:0; flex:1; background:var(--danger); display:none;">ì‚­ì œ</button>
            <button class="action-btn" onclick="document.getElementById('scheduleModal').style.display='none'" style="margin:0; flex:1; background:#90a4ae;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <button class="close-btn" onclick="closeModal()">Ã—</button>
        
        <div class="modal-header-profile">
            <div style="width:80px; height:80px; margin:0 auto; position:relative;" onclick="triggerPhotoEdit()">
                <img id="modalImg" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid var(--secondary); box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                <div class="admin-only" style="position:absolute; bottom:0; right:0; background:var(--primary); color:white; padding:4px 7px; border-radius:50%; font-size:11px;"><i class="fas fa-camera"></i></div>
            </div>
            <h2 id="modalName" style="margin:8px 0 4px 0; font-size:20px;"></h2>
            <div id="modalInfo" style="color:var(--text-sub); font-size:13px;"></div>
            <input type="file" id="editPhotoInput" accept="image/*" style="display:none;" onchange="previewEditPhoto()">
        </div>

        <div class="modal-tab-nav">
            <button class="modal-tab-btn active" onclick="switchModalTab('tabDaily', this)">ğŸ“‹ í•™ìŠµ/ì¶œì„</button>
            <button class="modal-tab-btn" onclick="switchModalTab('tabScore', this)">ğŸ“ˆ ì„±ì /ìƒë‹´</button>
            <button class="modal-tab-btn" onclick="switchModalTab('tabInfo', this)">âš™ï¸ ì •ë³´/ì •ì‚°</button>
        </div>

        <div id="tabDaily" class="modal-tab-pane active">
            <div class="stat-box" style="margin: 0 0 15px 0;">
                <div class="stat-item"><div class="stat-num" id="statMonth">0%</div><div style="font-size:12px;">ì´ë²ˆë‹¬ ì¶œì„ë¥ </div></div>
                <div class="stat-item"><div class="stat-num" id="statTotal">0íšŒ</div><div style="font-size:12px;">ì´ ë“±ì›ì¼</div></div>
            </div>

            <button class="action-btn" id="attendBtn" onclick="sendSmsFromModal()" style="margin-top:0; margin-bottom:20px; background: linear-gradient(135deg, #009688, #00796b);">
                <i class="fas fa-paper-plane"></i> ë“±ì› ë¬¸ì & ì¶œì„ì²˜ë¦¬
            </button>

            <div style="background:#fffde7; border:1px solid #fff9c4; border-radius:10px; padding:15px;">
                <h4 style="margin:0 0 10px 0; color:#fbc02d;"><i class="fas fa-bullhorn"></i> ì˜¤ëŠ˜ì˜ í•™ìŠµ ì•ˆë‚´</h4>
                <textarea id="dailyProgress" rows="2" placeholder="ì˜¤ëŠ˜ ê³µë¶€í•œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="background:white; margin-bottom:8px;"></textarea>
                <div id="noticePreview" style="background:white; padding:10px; border:1px dashed #ddd; font-size:12px; white-space:pre-wrap; color:#555; margin-bottom:8px; min-height:40px;">(ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°)</div>
                <div class="modal-action-row">
                    <button class="action-btn" onclick="generateNotice()" style="background:#fbc02d; margin-top:0;">ğŸ“ ì–‘ì‹ ìƒì„±</button>
                    <button class="action-btn" onclick="copyNotice()" style="background:#ffa000; margin-top:0;">ğŸ“‹ ë³µì‚¬</button>
                    <button class="action-btn" onclick="sendKakao()" style="background:#fee500; color:#3c1e1e; margin-top:0;"><i class="fas fa-comment"></i> ì¹´í†¡ ì „ì†¡</button>
                </div>
            </div>
        </div>

        <div id="tabScore" class="modal-tab-pane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0; color:var(--text-main);">ğŸ’¬ ìƒë‹´ ë° í•™ìŠµ ë¡œê·¸</h4>
                <span style="font-size:12px; color:#999;">ìµœê·¼ ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</span>
            </div>

            <div id="modalCounselLog" style="background:#f5f7f9; border-radius:8px; padding:15px; height:250px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee;"></div>
            
            <div class="admin-only" style="display:flex; gap:5px; margin-bottom:20px;">
                <input type="text" id="newCounsel" placeholder="ìƒë‹´ ë‚´ìš© ê¸°ë¡" style="flex:1;">
                <button onclick="addCounselLog()" style="background:var(--primary); color:white; border:none; padding:0 20px; border-radius:8px; font-weight:bold;">ë“±ë¡</button>
            </div>

            <details style="background:white; border:1px solid #e0e0e0; border-radius:10px; padding:10px;">
                <summary style="font-weight:bold; color:#7b1fa2; cursor:pointer; padding:5px; list-style:none; display:flex; align-items:center; justify-content:space-between;">
                    <span>ğŸ“ˆ ì„±ì  ê·¸ë˜í”„ ë° ê¸°ë¡ ê´€ë¦¬</span>
                    <i class="fas fa-chevron-down" style="font-size:12px; color:#aaa;"></i>
                </summary>
                
                <div style="margin-top:15px; padding-top:15px; border-top:1px dashed #eee;">
                    <div class="chart-container" style="padding:0; margin-bottom:15px; border:none;">
                        <canvas id="scoreChart" height="180"></canvas>
                    </div>

                    <div class="admin-only" style="background:#f3e5f5; padding:12px; border-radius:8px; margin-bottom:15px;">
                        <div style="font-size:12px; font-weight:bold; color:#7b1fa2; margin-bottom:5px;">ìƒˆ ì„±ì  ë“±ë¡</div>
                        <div class="score-input-group">
                            <input type="text" id="scoreTitle" placeholder="ì‹œí—˜ëª…" style="flex:1.5;">
                            <input type="number" id="scoreValue" placeholder="ì ìˆ˜" style="flex:1;">
                            <button onclick="addScore()" style="background:#7b1fa2; color:white; border:none; padding:0 15px; border-radius:6px;">ì¶”ê°€</button>
                        </div>
                    </div>

                    <h5 style="margin:0 0 8px 0; color:#555;">ğŸ“ ì„±ì  ê¸°ë¡ ìƒì„¸</h5>
                    <div id="scoreList" style="font-size:13px; max-height:150px; overflow-y:auto; color:#666;"></div>
                </div>
            </details>
        </div>

        <div id="tabInfo" class="modal-tab-pane">
            <div class="settlement-box" style="margin-top:0;">
                <h4 class="settlement-title" style="margin-top:0;"><i class="fas fa-file-invoice-dollar"></i> êµìœ¡ë¹„ ì •ì‚° ì•ˆë‚´</h4>
                <div id="settlementPreview" style="background:white; padding:10px; border:1px solid #bbdefb; font-size:12px; white-space:pre-wrap; margin-bottom:8px; color:#333;"></div>
                <div class="modal-action-row">
                    <button onclick="generateSettlement()" class="action-btn" style="background:#1976d2; margin-top:0;">ë¬¸êµ¬ ìƒì„±</button>
                    <button onclick="copyText('settlementPreview')" class="action-btn" style="background:#1565c0; margin-top:0;">ë³µì‚¬</button>
                </div>
            </div>

            <div class="admin-only">
                <h4 style="margin:20px 0 10px 0; border-top:1px solid #eee; padding-top:15px;">í•™ìƒ ì •ë³´ ìˆ˜ì •</h4>
                <div id="modalEditForm" class="form-grid" style="grid-template-columns: 1fr;">
                    <input type="hidden" id="editId">
                    <div><label>ì´ë¦„</label><input type="text" id="editName"></div>
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;"><label>ìƒë…„ì›”ì¼</label><input type="date" id="editBirth"></div>
                        <div style="flex:1;"><label>ì„±ë³„</label><select id="editGender"><option value="ë‚¨">ë‚¨</option><option value="ì—¬">ì—¬</option></select></div>
                    </div>
                    <div><label>í•™ë…„/ê³¼ì •</label>
                        <select id="editGrade"> 
                            <option value="ë¯¸ì·¨í•™">ë¯¸ì·¨í•™</option><option value="ì´ˆë“±1-2">ì´ˆë“± 1~2í•™ë…„</option>
                            <option value="ì´ˆë“±3-4">ì´ˆë“± 3~4í•™ë…„</option><option value="ì´ˆë“±5-6">ì´ˆë“± 5~6í•™ë…„</option>
                            <option value="ì¤‘ë“±ë¶€">ì¤‘ë“±ë¶€</option><option value="ê³ ë“±ë¶€">ê³ ë“±ë¶€</option>
                        </select>
                    </div>
                    <div><label>í•™êµ</label><input type="text" id="editSchool"></div>
                    <div><label>ë¶€ëª¨ë‹˜ ì—°ë½ì²˜</label><input type="tel" id="editParentPhone"></div>
                    <div><label>í•™ìƒ ì—°ë½ì²˜</label><input type="tel" id="editStudentPhone"></div>
                    <div><label>ì£¼ì†Œ</label><input type="text" id="editAddress"></div>
                    <div><label>íŠ¹ì´ì‚¬í•­</label><textarea id="editNotes" rows="2"></textarea></div>
                </div>
                <div class="modal-action-row" style="margin-top:15px;">
                    <button class="action-btn" onclick="saveEdit()" style="background:var(--primary); margin-top:0;">ì €ì¥</button>
                    <button class="action-btn" onclick="deleteStudent()" style="background:var(--danger); margin-top:0;">ì‚­ì œ</button>
                </div>
            </div>
            
            <p style="text-align:center; color:#999; font-size:12px; margin-top:20px;">
                * ì •ë³´ ìˆ˜ì • ë° ì •ì‚° ê¸°ëŠ¥ì€<br>ì„ ìƒë‹˜ ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div><div id="printArea">
    <div style="text-align:center; font-size:24px; font-weight:bold; text-decoration:underline;">ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„ êµì‹¤ ì›ìƒ ëª…ë‹¨</div>
    <div style="text-align:right; font-size:12px; margin-top:10px;" id="printDate"></div>
    <table class="print-table">
        <thead>
            <tr><th>No</th><th>ì´ë¦„</th><th>í•™ë…„/ê³¼ì •</th><th>í•™êµ</th><th>í•™ë¶€ëª¨ ì—°ë½ì²˜</th><th>í•™ìƒ ì—°ë½ì²˜</th></tr>
        </thead>
        <tbody id="printTbody"></tbody>
    </table>
</div>

<script type="module">
    // Firebase SDK ë° ì„¤ì • (ê¸°ì¡´ í‚¤ ìœ ì§€)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, getDoc, setDoc, arrayUnion, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
      authDomain: "namyang-f3a98.firebaseapp.com",
      projectId: "namyang-f3a98",
      storageBucket: "namyang-f3a98.firebasestorage.app",
      messagingSenderId: "641432133626",
      appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
      measurementId: "G-23L6KZERMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    

// ===================== SMS ì„œë²„(ì¹´í˜24 ì•Œë¦¬ê³ ) ì„¤ì • =====================
// [ì£¼ì˜] ë°°í¬ëœ ê³³ì´ https(ë³´ì•ˆ)ë¼ë©´ SMS ì„œë²„ë„ httpsë¡œ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.
const SMS_SERVER_BASE = "http://canyone2302.cafe24app.com"; 

// (ê¶Œì¥) ìµœì†Œ ë³´ì•ˆí‚¤: ì„œë²„(web.js)ì—ë„ ê°™ì€ í‚¤ë¥¼ ë„£ê³  ê²€ì¦í•˜ë©´ ì™¸ë¶€ ë‚¨ìš©ì„ ë§‰ì„ ìˆ˜ ìˆì–´ìš”.
const SMS_CLIENT_KEY = "CHANGE_ME_TO_A_LONG_RANDOM_STRING";

// ì„œë²„ë¡œ ë¬¸ì ë°œì†¡(ë‚´ì¥ fetch ì‚¬ìš©)
async function sendSmsByServer(receiver, msg) {
  const res = await fetch(`${SMS_SERVER_BASE}/send-sms`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": SMS_CLIENT_KEY
    },
    body: JSON.stringify({ receiver, msg })
  });

  const data = await res.json().catch(async () => ({ raw: await res.text() }));
  const ok = data.success === true || data.result_code === "1" || data.result_code === 1;
  return { ok, data };
}


// ========================================================================
// ë°ì´í„° ìƒíƒœ ê´€ë¦¬
    let allStudents = [];
    let allSchedules = [];
    let currentStudentId = null;
    let selectedStudentIds = new Set();
    
    // [ì¤‘ìš”] ì´ ë³€ìˆ˜ê°€ ë¹ ì ¸ì„œ ì˜¤ë¥˜ê°€ ë‚¬ìŠµë‹ˆë‹¤. ê¼­ ì¶”ê°€í•´ì£¼ì„¸ìš”!
    let selectedDateStr = new Date().toISOString().slice(0, 10);
    
    // í•„í„° ìƒíƒœ
    let currentGradeFilter = 'all'; 
    let calDate = new Date();
    let myChart = null;

    // ë  ìˆœì„œ -> í•™ë…„ ìˆœì„œë¡œ ë¡œì§ ë³€ê²½
    const gradeOrder = { 'ë¯¸ì·¨í•™': 0, 'ì´ˆë“±1-2': 1, 'ì´ˆë“±3-4': 2, 'ì´ˆë“±5-6': 3, 'ì¤‘ë“±ë¶€': 4, 'ê³ ë“±ë¶€': 5 };

    // --- ë°ì´í„° ë¡œë“œ ---
    onSnapshot(collection(db, "students"), (snapshot) => {
        allStudents = [];
        snapshot.forEach((doc) => { allStudents.push({ id: doc.id, ...doc.data() }); });
        updateSchoolOptions();
        filterList();
        renderCalendar();
        // ìƒì„¸ì°½ ê°±ì‹ 
        if(document.getElementById('detailModal').style.display === 'flex' && currentStudentId) {
            const s = allStudents.find(st => st.id === currentStudentId);
            if(s) openDetail(s);
        }
    });

    onSnapshot(query(collection(db, "schedules"), orderBy("date")), (snapshot) => {
        allSchedules = [];
        snapshot.forEach((doc) => { allSchedules.push({ id: doc.id, ...doc.data() }); });
        renderCalendar();
    });

    // --- ë¦¬ìŠ¤íŠ¸ ë° í•„í„° ---
    function updateSchoolOptions() {
        const schools = new Set();
        allStudents.forEach(s => { if(s.school) schools.add(s.school); });
        const select = document.getElementById('schoolFilter');
        select.innerHTML = '<option value="all">ì „ì²´ í•™êµ</option>';
        Array.from(schools).sort().forEach(sc => select.innerHTML += `<option value="${sc}">${sc}</option>`);
    }


// [1] ì„±ì  ì¶”ê°€ í•¨ìˆ˜
window.addScore = async () => {
    const title = document.getElementById('scoreTitle').value;
    const score = document.getElementById('scoreValue').value;
    if(!title || !score) return alert("ì‹œí—˜ëª…ê³¼ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    const newScore = {
        date: new Date().toISOString().slice(0, 10),
        title: title,
        score: parseInt(score)
    };

    try {
        await updateDoc(doc(db, "students", currentStudentId), {
            scoreLog: arrayUnion(newScore)
        });
        document.getElementById('scoreTitle').value = "";
        document.getElementById('scoreValue').value = "";
        alert("ì„±ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e) { alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message); }
};

// [ìˆ˜ì •í•  ì½”ë“œ] ì„±ì  ê´€ë¦¬ ì „ì²´ (ê·¸ë˜í”„ + ë¦¬ìŠ¤íŠ¸ + ìˆ˜ì • + ì‚­ì œ)
window.renderScoreChart = (scoreLog = []) => {
    const canvas = document.getElementById('scoreChart');
    if(!canvas) return; 
    const ctx = canvas.getContext('2d');
    
    // ê¸°ì¡´ ì°¨íŠ¸ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
    if (myChart) myChart.destroy();

    const labels = scoreLog.map(item => item.title);
    const data = scoreLog.map(item => item.score);

    // ë””ìì¸: ê·¸ë¼ë°ì´ì…˜ ì„¤ì •
    const gradientStroke = ctx.createLinearGradient(0, 0, canvas.width, 0);
    gradientStroke.addColorStop(0, '#7b1fa2');
    gradientStroke.addColorStop(1, '#e91e63');

    const gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
    gradientFill.addColorStop(0, 'rgba(123, 31, 162, 0.3)');
    gradientFill.addColorStop(1, 'rgba(123, 31, 162, 0.0)');

    // ì°¨íŠ¸ ìƒì„±
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'ì„±ì ',
                data: data,
                borderColor: gradientStroke,
                backgroundColor: gradientFill,
                borderWidth: 3,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#7b1fa2',
                pointRadius: 5,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#333',
                    bodyColor: '#7b1fa2',
                    borderColor: '#ddd',
                    borderWidth: 1
                }
            },
            scales: {
                y: { min: 0, max: 100, grid: { borderDash: [5, 5] } },
                x: { grid: { display: false } }
            }
        }
    });

    // ë¦¬ìŠ¤íŠ¸ ìƒì„± (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í¬í•¨)
    const listArea = document.getElementById('scoreList');
    if(listArea) {
        if(scoreLog.length === 0) {
            listArea.innerHTML = "<div style='text-align:center; padding:10px; color:#aaa;'>ë“±ë¡ëœ ì„±ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        } else {
            listArea.innerHTML = scoreLog.map((s, index) => `
                <div style="
                    padding: 10px; margin-bottom: 6px; border-radius: 8px;
                    background: #fff; border: 1px solid #eee; 
                    display: flex; justify-content: space-between; align-items: center;
                ">
                    <div>
                        <span style="font-weight:bold; color:#333;">${s.title}</span>
                        <span style="font-size:12px; color:#888; margin-left:5px;">(${s.date})</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong style="color:#7b1fa2;">${s.score}ì </strong>
                        <div class="admin-only" style="display:flex; gap:5px; margin-left:5px;">
                            <i class="fas fa-pen" onclick="editScore(${index})" style="cursor:pointer; color:#1976d2; font-size:12px;" title="ìˆ˜ì •"></i>
                            <i class="fas fa-trash" onclick="deleteScore(${index})" style="cursor:pointer; color:#d32f2f; font-size:12px;" title="ì‚­ì œ"></i>
                        </div>
                    </div>
                </div>`
            ).reverse().join(''); 
        }
    }
};

// ì„±ì  ìˆ˜ì • í•¨ìˆ˜
window.editScore = async (index) => {
    const s = allStudents.find(st => st.id === currentStudentId);
    if (!s || !s.scoreLog || !s.scoreLog[index]) return;

    const oldData = s.scoreLog[index];
    const newTitle = prompt("ì‹œí—˜ëª…ì„ ìˆ˜ì •í•˜ì„¸ìš”:", oldData.title);
    if (newTitle === null) return;
    const newScore = prompt("ì ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", oldData.score);
    if (newScore === null) return;

    const newLog = [...s.scoreLog];
    newLog[index] = { date: oldData.date, title: newTitle, score: parseInt(newScore) };

    try {
        await updateDoc(doc(db, "students", currentStudentId), { scoreLog: newLog });
        alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message); }
};

// ì„±ì  ì‚­ì œ í•¨ìˆ˜
window.deleteScore = async (index) => {
    if(!confirm("ì •ë§ ì´ ì„±ì  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    const s = allStudents.find(st => st.id === currentStudentId);
    if (!s || !s.scoreLog) return;

    const newLog = s.scoreLog.filter((_, i) => i !== index);
    try {
        await updateDoc(doc(db, "students", currentStudentId), { scoreLog: newLog });
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
};
   // 3. ì›”ë§ ì •ì‚° ë¬¸êµ¬ ìƒì„± í•¨ìˆ˜
window.generateSettlement = () => {
    const s = allStudents.find(st => st.id === currentStudentId);
    const now = new Date();
    const month = now.getMonth() + 1;
    
    // ì´ë²ˆ ë‹¬ ì¶œì„ íšŸìˆ˜ ê³„ì‚°
    const thisMonthLogs = (s.attendanceLog || []).filter(log => {
        const d = log.toDate ? log.toDate() : new Date(log.seconds * 1000);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });

    const template = `[ë¯¸ë˜ì—”ìˆ˜í•™ ëŠ¥ë™í•´ëƒ„ êµì‹¤]
ì•ˆë…•í•˜ì„¸ìš”, í•™ë¶€ëª¨ë‹˜! 
ì–´ëŠë§ ${month}ì›” í•™ìŠµì„ ë§ˆë¬´ë¦¬í•  ì‹œê¸°ì…ë‹ˆë‹¤.

ğŸ—“ ${month}ì›” ì´ ë“±ì› íšŸìˆ˜: ${thisMonthLogs.length}íšŒ

í•œ ë‹¬ ë™ì•ˆ ì„±ì‹¤íˆ í•™ìŠµí•œ ${s.name} í•™ìƒì—ê²Œ ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
ë‹¤ìŒ ë‹¬ ìˆ˜ê°•ë£Œ ë° êµì¬ë¹„ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤.

âœ” ì•ˆë‚´ ë‚´ìš©: ${month+1}ì›” êµìœ¡ë¹„
âœ” ì…ê¸ˆ ê³„ì¢Œ: [ì€í–‰ëª… ì…ë ¥] [ê³„ì¢Œë²ˆí˜¸] (ì˜ˆê¸ˆì£¼: [ì´ë¦„])

ëŠ˜ ë¯¿ê³  ë§¡ê²¨ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ˜Š`;

    document.getElementById('settlementPreview').innerText = template;
};

// 4. í…ìŠ¤íŠ¸ ë³µì‚¬ ê³µí†µ í•¨ìˆ˜
window.copyText = (elementId) => {
    const text = document.getElementById(elementId).innerText;
    if(!text) return alert("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
    navigator.clipboard.writeText(text).then(() => alert("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
};


// openDetail í•¨ìˆ˜ ë‚´ë¶€ì— ì´ˆê¸°í™” ë¡œì§ ì¶”ê°€ (ê¸°ì¡´ openDetail í•¨ìˆ˜ ì•ˆì— í•œ ì¤„ ì¶”ê°€í•˜ì„¸ìš”)
// document.getElementById('dailyProgress').value = ""; 
// document.getElementById('noticePreview').innerText = "ì§„ë„ë¥¼ ì…ë ¥í•˜ê³  ì—…ë°ì´íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";

    window.setGradeFilter = (val, btn) => {
        currentGradeFilter = val;
        document.querySelectorAll('#ageFilterGroup .filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        filterList();
    };

   // [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (3D ë””ìì¸ ì ìš©)
// [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì´ë¯¸ ë“±ì›í–ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”)
window.filterList = () => {
    let keyword = "";
    const kioskInput = document.getElementById('kioskSearch');
    if(document.body.classList.contains('kiosk-mode') && kioskInput) {
        keyword = kioskInput.value.toLowerCase();
    } else {
        const searchInput = document.getElementById('searchKeyword');
        if(searchInput) keyword = searchInput.value.toLowerCase();
    }

    const schoolFilter = document.getElementById('schoolFilter').value;
    const todayStr = new Date().toDateString();
    const isKiosk = document.body.classList.contains('kiosk-mode');

    let filtered = allStudents.filter(s => {
        const matchName = s.name.toLowerCase().includes(keyword);
        const matchSchool = schoolFilter === 'all' || s.school === schoolFilter;
        if (isKiosk && keyword === "") return true; 
        return matchName && matchSchool;
    });

    filtered.sort((a, b) => a.name.localeCompare(b.name));

    const listArea = document.getElementById('studentListArea');
    listArea.innerHTML = "";
    
    filtered.forEach(s => {
        const imgSrc = s.photo || "https://via.placeholder.com/150?text=NO+IMAGE";
        
        // ì˜¤ëŠ˜ ì¶œì„ ì—¬ë¶€ ì²´í¬
        const hasAttended = (s.attendanceLog || []).some(log => {
            const d = log.toDate ? log.toDate() : new Date(log.seconds * 1000);
            return d.toDateString() === todayStr;
        });

        const div = document.createElement('div');
        div.className = `student-card ${hasAttended ? 'arrived' : ''}`;
        div.id = `card-${s.id}`;
        
        if (isKiosk) {
            // ë“±ì›í–ˆìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™” ì²˜ë¦¬
            const disableIn = hasAttended ? 'disabled' : '';
            const inBtnText = hasAttended ? 'ì™„ë£Œ' : 'ë“±ì›';

            div.innerHTML = `
                <div class="profile-wrapper">
                    <img src="${imgSrc}" class="profile-img">
                </div>
                
                <div class="info-area">
                    <div>${s.name}</div>
                    <small>${s.school || 'í•™êµë¯¸ì…ë ¥'} | ${s.belt || 'í•™ë…„'}</small>
                </div>

                <div class="kiosk-btn-group">
                    <button class="k-btn k-btn-in" onclick="quickAttendance('${s.id}', 'in', this)" ${disableIn}>${inBtnText}</button>
                    <button class="k-btn k-btn-out" onclick="quickAttendance('${s.id}', 'out', this)">í•˜ì›</button>
                </div>

                <div class="card-label">ATTENDANCE CARD</div>
            `;
        } else {
            // ê´€ë¦¬ì ëª¨ë“œ
            div.innerHTML = `
                <div class="profile-wrapper" onclick="openDetailById('${s.id}')" style="width:55px; height:55px; margin:0;">
                    <img src="${imgSrc}" class="profile-img" style="border-radius:50%;">
                </div>
                <div class="info-area" style="text-align:left; padding-left:15px;">
                    <div><strong style="color:#333; font-size:16px;">${s.name}</strong> <span class="grade-tag">${s.belt}</span></div>
                    <div style="font-size:13px; color:#777;">${s.school || '-'} Â· ${s.phone || 'ì—°ë½ì²˜ì—†ìŒ'}</div>
                </div>
                <div class="chk-wrapper">
                    <input type="checkbox" class="list-chk" value="${s.id}" onclick="toggleSelection('${s.id}', event)">
                </div>
            `;
            div.style.flexDirection = "row"; div.style.height = "auto"; div.style.background = "#fff";
            div.style.border = "1px solid #eceff1"; div.style.borderRadius = "12px"; div.style.padding = "15px";
            div.style.alignItems = "center"; div.style.boxShadow = "0 2px 5px rgba(0,0,0,0.02)";
        }
        
        listArea.appendChild(div);
    });
};
    window.openDetailById = (id) => {
        const s = allStudents.find(st => st.id === id);
        if(s) openDetail(s);
    }

    // --- ì¼ê´„ ì²˜ë¦¬ ---
    window.toggleSelection = (id, e) => {
        e.stopPropagation();
        if(selectedStudentIds.has(id)) selectedStudentIds.delete(id);
        else selectedStudentIds.add(id);
        updateBulkBtn();
    };

    window.toggleSelectAll = () => {
        const chk = document.getElementById('selectAll').checked;
        const visibleIds = Array.from(document.querySelectorAll('.list-chk')).map(el => el.value);
        if(chk) visibleIds.forEach(id => selectedStudentIds.add(id));
        else selectedStudentIds.clear();
        filterList();
    };

    function updateBulkBtn() {
        const count = selectedStudentIds.size;
        document.getElementById('selectedCount').innerText = `${count}ëª… ì„ íƒë¨`;
        document.getElementById('bulkActionBtn').style.display = count > 0 ? 'block' : 'none';
    }

    window.processBulkAttendance = async () => {
        if(!confirm(`ì„ íƒí•œ ${selectedStudentIds.size}ëª…ì—ê²Œ ë“±ì› ë¬¸ìë¥¼ ë°œì†¡í•˜ê³  ì¶œì„ì²˜ë¦¬ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        const phones = [];
        const promises = [];
        
        selectedStudentIds.forEach(id => {
            const s = allStudents.find(st => st.id === id);
            if(s) {
                promises.push(updateDoc(doc(db, "students", id), { attendanceLog: arrayUnion(new Date()) }));
                if(s.phone) phones.push(s.phone.replace(/[^0-9]/g, ''));
            }
        });

        try {
            await Promise.all(promises);
            const phoneStr = [...new Set(phones)].join(',');
            
            // ë¬¸ì ë°œì†¡ (ì¹´í˜24 ì•Œë¦¬ê³  ì„œë²„ë¡œ ìˆœì°¨ ì „ì†¡)
            const msg = "[ë¯¸ë˜ì—”ìˆ˜í•™] ìë…€ê°€ êµì‹¤ì— ë„ì°©í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤.";
            const uniqPhones = [...new Set(phones)];
            let success = 0, fail = 0;

            for (const p of uniqPhones) {
                try {
                    const { ok } = await sendSmsByServer(p, msg);
                    if (ok) success++;
                    else fail++;
                } catch(e) {
                    fail++;
                }
            }

} catch(e) { alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    };
// [ì¶”ê°€] ìƒì„¸ íŒì—…ì—ì„œ ë“±ì› ë¬¸ì ë³´ë‚´ê¸° ë° ì¶œì„ ì²˜ë¦¬ í•¨ìˆ˜
    window.sendSmsFromModal = async () => {
        // 1. í˜„ì¬ ì„ íƒëœ í•™ìƒ ì •ë³´ í™•ì¸
        if (!currentStudentId) return;
        const s = allStudents.find(st => st.id === currentStudentId);
        if (!s) return alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        if (!confirm(`${s.name} í•™ìƒì—ê²Œ ë“±ì› ë¬¸ìë¥¼ ë°œì†¡í•˜ê³  ì¶œì„ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            // 2. íŒŒì´ì–´ë² ì´ìŠ¤(DB)ì— ì¶œì„ ê¸°ë¡ ì €ì¥ (ì˜¤ëŠ˜ ë‚ ì§œ)
            await updateDoc(doc(db, "students", currentStudentId), {
                attendanceLog: arrayUnion(new Date())
            });

            // 3. í™”ë©´ì˜ ë²„íŠ¼ ìƒíƒœ ì¦‰ì‹œ ë³€ê²½ (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            const btn = document.getElementById('attendBtn');
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = "<i class='fas fa-check'></i> ì˜¤ëŠ˜ ë“±ì› ì™„ë£Œ";
            }

            // 4. ë¬¸ì ë°œì†¡ (ì¹´í˜24 ì•Œë¦¬ê³  ì„œë²„)
            if (s.phone) {
                const phone = s.phone.replace(/[^0-9]/g, '');
                const msg = `[ë¯¸ë˜ì—”ìˆ˜í•™] ${s.name} í•™ìƒì´ êµì‹¤ì— ë„ì°©í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤.`;

                const { ok, data } = await sendSmsByServer(phone, msg);
                if (!ok) {
                    alert("ë¬¸ì ì „ì†¡ ì‹¤íŒ¨: " + (data.message || JSON.stringify(data)));
                }
            } else {
                alert("í•™ë¶€ëª¨ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤. (ì¶œì„ ì²˜ë¦¬ëŠ” ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤)");
            }

} catch (e) {
            console.error(e);
            alert("ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
        }
    };
 // --- ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (ìˆ˜ì •ë¨) ---
    window.openDetail = (s) => {
        currentStudentId = s.id;
        document.getElementById('detailModal').style.display = 'flex';
        
        // 1. ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
        document.getElementById('modalImg').src = s.photo || "https://via.placeholder.com/150";
        document.getElementById('modalName').innerText = s.name;
        document.getElementById('modalInfo').innerText = `${s.school||''} | ${s.belt||''} | ${s.phone}`;
        
        // ìˆ˜ì • í¼ ë°ì´í„° ì±„ìš°ê¸°
        document.getElementById('editId').value = s.id;
        document.getElementById('editName').value = s.name;
        document.getElementById('editBirth').value = s.birth;
        document.getElementById('editGrade').value = s.belt;
        document.getElementById('editSchool').value = s.school || "";
        document.getElementById('editGender').value = s.gender;
        document.getElementById('editParentPhone').value = s.phone;
        document.getElementById('editStudentPhone').value = s.studentPhone || "";
        document.getElementById('editAddress').value = s.address || "";
        document.getElementById('editNotes').value = s.notes || "";

        // 2. ê¸°ëŠ¥ ë° ë¡œê·¸ ì´ˆê¸°í™” (ì—¬ê¸°ê°€ í•µì‹¬!)
        if(window.calcStats) calcStats(s);
        
       // [ìˆ˜ì •ë¨] ìƒë‹´ ë‚´ì—­ ë Œë”ë§ (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
const logArea = document.getElementById('modalCounselLog');
if(logArea) {
    logArea.innerHTML = "";
    const logs = s.counselLog || [];
    
    if(logs.length === 0) {
        logArea.innerHTML = "<div style='color:#ccc; text-align:center; padding:10px;'>ìƒë‹´ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    }

    logs.forEach((log, index) => {
        const div = document.createElement('div');
        div.className = 'log-item';
        
        // ì„ ìƒë‹˜ ëª¨ë“œì¼ ë•Œë§Œ ë³´ì´ëŠ” ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼
        const btnHtml = `
            <div class="admin-only" style="float:right; margin-left:10px;">
                <i class="fas fa-pen" onclick="editCounselLog(${index})" style="cursor:pointer; color:#1976d2; margin-right:8px;" title="ìˆ˜ì •"></i>
                <i class="fas fa-trash" onclick="deleteCounselLog(${index})" style="cursor:pointer; color:#d32f2f;" title="ì‚­ì œ"></i>
            </div>`;
        
        // ë‚´ìš© ì¡°ë¦½
        div.innerHTML = `
            ${btnHtml}
            <span style="color:#009688; font-weight:bold;">[${log.date}]</span> 
            <span>${log.text}</span>
            <div style="clear:both;"></div>
        `;
        logArea.appendChild(div);
    });
}

        // ì„±ì  ê·¸ë˜í”„ (ìˆìœ¼ë©´ í˜¸ì¶œ)
        if(window.renderScoreChart) renderScoreChart(s.scoreLog || []); 
        
        // 3. ì…ë ¥ì°½ ë° ë²„íŠ¼ ì´ˆê¸°í™”
        if(document.getElementById('dailyProgress')) document.getElementById('dailyProgress').value = ""; 
        if(document.getElementById('newCounsel')) document.getElementById('newCounsel').value = "";
        
        // 4. ë“±ì› ë²„íŠ¼ ìƒíƒœ
        const today = new Date().toDateString();
        const attended = (s.attendanceLog||[]).some(ts => {
            const d = ts.toDate ? ts.toDate() : new Date(ts.seconds*1000);
            return d.toDateString() === today;
        });
        const btn = document.getElementById('attendBtn');
        if(attended) {
            btn.disabled = true;
            btn.innerHTML = "<i class='fas fa-check'></i> ì˜¤ëŠ˜ ë“±ì› ì™„ë£Œ";
        } else {
            btn.disabled = false;
            btn.innerHTML = "<i class='fas fa-paper-plane'></i> ë“±ì› ë¬¸ì ë³´ë‚´ê¸° (í•™ë¶€ëª¨)";
        }
    };

        

    window.deleteStudent = async () => {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await deleteDoc(doc(db, "students", currentStudentId));
            closeModal();
        }
    };

  // --- [ë‹¬ë ¥ & ì¼ì • í†µí•© ì—…ê·¸ë ˆì´ë“œ ì½”ë“œ] ---
    
    // ë³´ê¸° ëª¨ë“œ ìƒíƒœ ê´€ë¦¬ (ê¸°ë³¸ê°’: ì¼ê°„)
    let currentViewMode = 'day'; 

    // [1] ë‹¬ë ¥ ê·¸ë¦¬ê¸°
    window.renderCalendar = () => {
        const y = calDate.getFullYear(), m = calDate.getMonth();
        document.getElementById('calTitle').innerText = `${y}ë…„ ${m+1}ì›”`;
        
        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m+1, 0).getDate();
        const grid = document.getElementById('calGrid');
        grid.innerHTML = "";

        // ì´ë²¤íŠ¸ ë°ì´í„° ì¤€ë¹„
        let events = [];
        if(document.getElementById('showSchedule') && document.getElementById('showSchedule').checked) {
            events = [...events, ...allSchedules.map(s => ({...s, type:'schedule'}))];
        }
        // ìƒì¼ ë°ì´í„°
        if(document.getElementById('showBirthday') && document.getElementById('showBirthday').checked) {
            allStudents.forEach(s => {
                if(s.birth && s.birth.includes(`-${String(m+1).padStart(2,'0')}-`)) 
                    events.push({date: `${y}-${s.birth.slice(5)}`, title: `${s.name} ìƒì¼`, type:'birthday'});
            });
        }

        // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
        for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;

        // ë‚ ì§œ ì¹¸ ì±„ìš°ê¸°
        for(let d=1; d<=last; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const dayEvents = events.filter(e => e.date === dateStr);
            const isToday = dateStr === new Date().toISOString().slice(0,10) ? 'today' : '';
            const isSelected = dateStr === selectedDateStr ? 'border: 2px solid var(--primary);' : '';
            
            // ì (Dot) í‘œì‹œ
            let dots = "";
            dayEvents.forEach(e => { dots += `<span class="event-dot dot-${e.type}"></span>`; });

            grid.innerHTML += `
                <div class="day-cell ${isToday}" style="${isSelected}" onclick="clickDate('${dateStr}')">
                    <span class="day-num">${d}</span>
                    <div style="display:flex; gap:2px; justify-content:center; flex-wrap:wrap;">${dots}</div>
                </div>`;
        }
        
        // ë‹¬ë ¥ì„ ê·¸ë¦´ ë•Œ ë¦¬ìŠ¤íŠ¸ë„ ê°±ì‹ 
        updateScheduleList();
    };

    // [2] ë³´ê¸° ëª¨ë“œ ë³€ê²½ (ì¼ê°„/ì£¼ê°„/ì›”ê°„/ì—°ê°„)
    window.changeListView = (mode, btn) => {
        currentViewMode = mode;
        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
        document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
        updateScheduleList();
    };

    // [3] ë‚ ì§œ í´ë¦­ ì‹œ ë™ì‘ (ë¬´ì¡°ê±´ íŒì—… ë„ìš°ê¸° í¬í•¨)
    window.clickDate = (date) => {
        selectedDateStr = date;
        renderCalendar(); // ì„ íƒ íš¨ê³¼ ê°±ì‹ 
        
        // ë‚ ì§œë¥¼ ì°ìœ¼ë©´ 'ì¼ê°„' ëª¨ë“œë¡œ ìë™ ì „í™˜
        currentViewMode = 'day';
        document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
        const dayBtn = document.querySelectorAll('.view-mode-btn')[0];
        if(dayBtn) dayBtn.classList.add('active');
        
        updateScheduleList(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 

        // [ìš”ì²­í•˜ì‹  ê¸°ëŠ¥] ì„ ìƒë‹˜ ëª¨ë“œë¼ë©´, ì¼ì •ì´ ìˆë“  ì—†ë“  ë“±ë¡ íŒì—… ë„ìš°ê¸°
        if (document.body.classList.contains('show-admin')) {
            openScheduleModal('', '', date);
        }
    };

    // [4] ì¼ì • ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (í•µì‹¬ ë¡œì§)
    function updateScheduleList() {
        const date = selectedDateStr;
        const listArea = document.getElementById('dailyEventList');
        const titleElem = document.getElementById('selectedDateText') ? document.getElementById('selectedDateText').querySelector('span') : null;
        
        // ê¸°ì¤€ ë‚ ì§œ ê³„ì‚°
        let startDate = new Date(date);
        let endDate = new Date(date);
        let titleText = "";

        if (currentViewMode === 'day') {
            titleText = `${date} ì¼ì •`;
        } 
        else if (currentViewMode === 'week') {
            const day = startDate.getDay(); 
            startDate.setDate(startDate.getDate() - day); // ì¼ìš”ì¼
            endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 6); // í† ìš”ì¼
            titleText = `${startDate.toISOString().slice(5,10)} ~ ${endDate.toISOString().slice(5,10)} (ì£¼ê°„)`;
        } 
        else if (currentViewMode === 'month') {
            startDate.setDate(1);
            endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
            titleText = `${date.slice(0, 7)} ì „ì²´ ì¼ì • (ì›”ê°„)`;
        } 
        else if (currentViewMode === 'year') {
            startDate = new Date(startDate.getFullYear(), 0, 1);
            endDate = new Date(startDate.getFullYear(), 11, 31);
            titleText = `${startDate.getFullYear()}ë…„ ì „ì²´ ì¼ì • (ì—°ê°„)`;
        }

        if(titleElem) titleElem.innerText = titleText;
        const dateInput = document.getElementById('schedDate');
        if(dateInput) dateInput.value = date;
        
        // ê´€ë¦¬ì ë²„íŠ¼
        const isAdmin = document.body.classList.contains('show-admin');
        const addBtn = document.getElementById('addSchedBtn');
        if(addBtn) addBtn.style.display = isAdmin ? 'block' : 'none';

        // --- ì¼ì • í•„í„°ë§ ---
        let events = [];
        
        // 1. ìŠ¤ì¼€ì¤„
        allSchedules.forEach(s => {
            if (s.date >= startDate.toISOString().slice(0,10) && s.date <= endDate.toISOString().slice(0,10)) {
                events.push({ ...s, type: 'schedule' });
            }
        });

        // 2. ìƒì¼ (ì„ ìƒë‹˜ ëª¨ë“œì—ì„œë§Œ ë³´ì´ê²Œ í•˜ë ¤ë©´ ì¡°ê±´ ì¶”ê°€ ê°€ëŠ¥, í˜„ì¬ëŠ” ë‹¤ ë³´ì„)
        // ë²”ìœ„ ë‚´ ë‚ ì§œ ìˆœíšŒí•˜ë©° ìƒì¼ ì°¾ê¸°
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const y = d.getFullYear();
            const mStr = String(d.getMonth() + 1).padStart(2, '0');
            const dStr = String(d.getDate()).padStart(2, '0');
            const checkDate = `-${mStr}-${dStr}`; 
            
            allStudents.forEach(s => {
                if (s.birth && s.birth.includes(checkDate)) {
                    events.push({ 
                        date: `${y}${checkDate}`, 
                        title: `${s.name} ìƒì¼`, 
                        type: 'birthday',
                        id: s.id 
                    });
                }
            });
        }

        // ë‚ ì§œìˆœ ì •ë ¬
        events.sort((a, b) => a.date.localeCompare(b.date));

        // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
        if (events.length === 0) {
            listArea.innerHTML = "<div style='color:#999; padding:15px; text-align:center; font-size:13px;'>í•´ë‹¹ ê¸°ê°„ì— ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        } else {
            listArea.innerHTML = events.map(e => {
                const icon = e.type === 'birthday' ? 'ğŸ‚' : 'ğŸ“…';
                const isSched = e.type === 'schedule';
                // ì¼ì • ìˆ˜ì • íŒì—… ì—°ê²°
                const clickAction = (isSched && isAdmin) ? `onclick="openScheduleModal('${e.id}', '${e.title}', '${e.date}')"` : "";
                const dateTag = currentViewMode !== 'day' ? `<span class="event-date-tag">${e.date.slice(5)}</span>` : ""; 
                const editHint = (isSched && isAdmin) ? '<i class="fas fa-pen" style="color:#ddd; margin-left:5px;"></i>' : '';

                return `
                <div class="daily-event-item" ${clickAction} style="${clickAction ? 'cursor:pointer;' : ''}">
                    <div style="display:flex; align-items:center;">
                        ${dateTag}
                        <span style="margin-right:6px;">${icon}</span> 
                        <span style="font-weight:bold; color:#333;">${e.title}</span>
                    </div>
                    ${editHint}
                </div>`;
            }).join('');
        }
    }

    // [5] ì›” ë³€ê²½
    window.changeCalDate = (n) => { 
        calDate.setMonth(calDate.getMonth() + n); 
        renderCalendar(); 
    };

    // [6] íŒì—… ì—´ê¸°
    window.openScheduleModal = (id = '', title = '', date = '') => {
        const modalDate = date || selectedDateStr;
        const modal = document.getElementById('scheduleModal');
        if(modal) modal.style.setProperty('display', 'flex', 'important');
        
        document.getElementById('schedId').value = id;
        document.getElementById('schedTitle').value = title;
        document.getElementById('schedDate').value = modalDate;
        
        if(id) {
            document.getElementById('schedModalTitle').innerText = "ì¼ì • ìˆ˜ì •/ì‚­ì œ";
            document.getElementById('btnDelSched').style.display = 'inline-block';
        } else {
            document.getElementById('schedModalTitle').innerText = "ìƒˆ ì¼ì • ë“±ë¡";
            document.getElementById('btnDelSched').style.display = 'none';
        }
    };

    // [7] ì €ì¥
    window.saveSchedule = async () => {
        const id = document.getElementById('schedId').value;
        const title = document.getElementById('schedTitle').value;
        const date = document.getElementById('schedDate').value;
        
        if(!title || !date) return alert("ë‚´ìš©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        try {
            if(id) {
                await updateDoc(doc(db, "schedules", id), { title, date });
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                await addDoc(collection(db, "schedules"), { title, date });
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            document.getElementById('scheduleModal').style.display = 'none';
            renderCalendar(); // ì €ì¥ í›„ ê°±ì‹ 
        } catch(e) { alert("ì˜¤ë¥˜: " + e.message); }
    };

    // [8] ì‚­ì œ
    window.deleteSchedule = async () => {
        const id = document.getElementById('schedId').value;
        if(!id) return;
        if(confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            try {
                await deleteDoc(doc(db, "schedules", id));
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('scheduleModal').style.display = 'none';
                renderCalendar(); // ì‚­ì œ í›„ ê°±ì‹ 
            } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
        }
    };
// --- [ëˆ„ë½ëœ í•„ìˆ˜ ê¸°ëŠ¥ ë³µêµ¬] ---

    // 1. íƒ­ í™”ë©´ ì „í™˜ (ì´ê²Œ ì—†ìœ¼ë©´ ë©”ë‰´ê°€ ì•ˆ ëˆŒë¦½ë‹ˆë‹¤)
    window.showPage = (id) => {
        if (window.isKioskMode && window.isKioskMode() && id !== 'list') {
            return; // í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œì—ì„œëŠ” ì›ìƒê´€ë¦¬(ì¶œì„)ë§Œ ì‚¬ìš©
        }

        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        // íƒ­ ë²„íŠ¼ ìƒ‰ìƒ í™œì„±í™”
        const idx = id === 'register' ? 0 : id === 'list' ? 1 : 2;
        const tabs = document.querySelectorAll('.tab-btn');
        if(tabs[idx]) tabs[idx].classList.add('active');
        
        if(id === 'calendar') {
            if(window.renderCalendar) window.renderCalendar();
        }
    };

// [ìˆ˜ì •] ì„ ìƒë‹˜ ëª¨ë“œ í† ê¸€ í•¨ìˆ˜ (ì¶œì„ë¶€ ë²„íŠ¼ ì—°ë™)
window.toggleAdminMode = async () => {
    const chk = document.getElementById('adminToggle');
    const btnKiosk = document.getElementById('btnKioskStart');
    
    if(chk.checked) {
        // DB ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ë¡œì§ (ê¸°ì¡´ ì½”ë“œ í™œìš©)
        let dbPw = "1234"; 
        try {
            const docSnap = await getDoc(doc(db, "settings", "admin"));
            if (docSnap.exists()) dbPw = docSnap.data().password;
        } catch(e) {}

        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(pw === dbPw) { 
            document.body.classList.add('show-admin');
            if(btnKiosk) btnKiosk.style.display = 'inline-block'; // [ì¤‘ìš”] ì¶œì„ë¶€ ë²„íŠ¼ ë³´ì´ê¸°
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            chk.checked = false;
        }
    } else {
        document.body.classList.remove('show-admin');
        if(btnKiosk) btnKiosk.style.display = 'none'; // [ì¤‘ìš”] ì¶œì„ë¶€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    }
};
    // 3. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ëŠ¥
    window.changeAdminPassword = async () => {
        const newPw = prompt("ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(newPw) {
            await setDoc(doc(db, "settings", "admin"), { password: newPw });
            alert("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    };

    // 4. ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ (ì‚¬ì§„ ë“±ë¡ ì‹œ í•„ìš”)
    function resizeImage(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 300/img.width; // 300px ë„ˆë¹„ë¡œ ì¡°ì •
                    canvas.width = 300; 
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // 5. ì‚¬ì§„ ìˆ˜ì • íŠ¸ë¦¬ê±°
    window.triggerPhotoEdit = () => {
        if(document.body.classList.contains('show-admin')) {
            document.getElementById('editPhotoInput').click();
        }
    };
    window.previewEditPhoto = async () => {
        const file = document.getElementById('editPhotoInput').files[0];
        if(file) document.getElementById('modalImg').src = await resizeImage(file);
    };

    // 6. ì—‘ì…€ ì €ì¥
    window.downloadExcel = () => {
        const data = allStudents.map((s, i) => ({ 
            "ì—°ë²ˆ": i+1, "ì´ë¦„": s.name, "í•™êµ": s.school, "í•™ë…„": s.belt, 
            "ë¶€ëª¨ë‹˜ì—°ë½ì²˜": s.phone, "í•™ìƒì—°ë½ì²˜": s.studentPhone, "ì£¼ì†Œ": s.address, "ë©”ëª¨": s.notes 
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ì›ìƒëª…ë‹¨");
        XLSX.writeFile(wb, `ëª…ë‹¨_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // 7. ë°±ì—… ë° ë³µêµ¬
    window.downloadBackup = () => {
        const blob = new Blob([JSON.stringify(allStudents)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = "backup.json"; a.click();
    };
    window.restoreData = (e) => {
        const reader = new FileReader();
        reader.onload = async (evt) => {
            const data = JSON.parse(evt.target.result);
            if(confirm(`${data.length}ëª…ì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                for(const s of data) {
                    const { id, ...rest } = s; 
                    await addDoc(collection(db, "students"), { ...rest, regDate: serverTimestamp() });
                }
                alert("ë³µêµ¬ ì™„ë£Œ");
            }
        };
        reader.readAsText(e.target.files[0]);
    };
// [ì¶”ê°€] ëª¨ë‹¬ ë‹«ê¸° ê¸°ëŠ¥
window.closeModal = () => {
    document.getElementById('detailModal').style.display = 'none';
    currentStudentId = null; // ì„ íƒëœ í•™ìƒ ID ì´ˆê¸°í™”
};

// [ì¶”ê°€] ëª¨ë‹¬ ë°”ê¹¥ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = (event) => {
    const detailModal = document.getElementById('detailModal');
    const schedModal = document.getElementById('scheduleModal');
    if (event.target == detailModal) closeModal();
    if (event.target == schedModal) schedModal.style.display = "none";
};

// 6. [ì¹´ì¹´ì˜¤í†¡] ì „ì†¡ ê¸°ëŠ¥ ì¬ì„¤ì •
window.sendKakao = () => {
    // í‚¤ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ì‹œë„ (ë³¸ì¸ì˜ JavaScript í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
    if (window.Kakao && !Kakao.isInitialized()) {
        Kakao.init('0a302951dba10cb82dbfc0b603784155'); 
    }

    const s = allStudents.find(st => st.id === currentStudentId);
    if (!s) return alert("í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

    // ì…ë ¥ëœ ìƒë‹´ ë‚´ìš© ë˜ëŠ” ì•Œë¦¼ì¥ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    const text = document.getElementById('newCounsel').value || document.getElementById('noticePreview').innerText;
    
    if(!text) return alert("ì „ì†¡í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

    try {
        Kakao.Share.sendDefault({
            objectType: 'text',
            text: `[ë¯¸ë˜ì—”ìˆ˜í•™] ${s.name} í•™ìƒ í•™ìŠµ ì•ˆë‚´\n\n${text}`,
            link: {
                mobileWebUrl: 'https://shee-9qs.pages.dev',
                webUrl: 'https://shee-9qs.pages.dev',
            },
            buttonTitle: 'í•™ì›ì •ë³´ í™•ì¸',
        });
    } catch(err) {
        alert("ì¹´ì¹´ì˜¤í†¡ ì „ì†¡ ì‹¤íŒ¨: " + err);
    }
};
// [ì¶”ê°€] ìƒë‹´ ë¡œê·¸ ìˆ˜ì • ê¸°ëŠ¥
window.editCounselLog = async (index) => {
    // 1. í˜„ì¬ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const s = allStudents.find(st => st.id === currentStudentId);
    if (!s || !s.counselLog || !s.counselLog[index]) return;

    const oldLog = s.counselLog[index];
    
    // 2. ìˆ˜ì • ë‚´ìš© ì…ë ¥ë°›ê¸°
    const newText = prompt("ìƒë‹´ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”:", oldLog.text);
    if (newText === null || newText === oldLog.text) return; // ì·¨ì†Œí•˜ê±°ë‚˜ ë³€ê²½ ì—†ìœ¼ë©´ ì¤‘ë‹¨

    // 3. ë°ì´í„° ì—…ë°ì´íŠ¸ (ë°°ì—´ ì „ì²´ë¥¼ ë®ì–´ì“°ëŠ” ë°©ì‹)
    const newLogs = [...s.counselLog];
    newLogs[index] = { date: oldLog.date, text: newText }; // ë‚ ì§œëŠ” ìœ ì§€í•˜ê³  ë‚´ìš©ë§Œ ë³€ê²½

    try {
        await updateDoc(doc(db, "students", currentStudentId), { counselLog: newLogs });
        alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        // UIëŠ” onSnapshotì— ì˜í•´ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤.
    } catch(e) {
        alert("ìˆ˜ì • ì‹¤íŒ¨: " + (e?.message || e));
    }
};

// [ì¶”ê°€] ìƒë‹´ ë‚´ì—­ ì €ì¥ í•¨ìˆ˜ (ì‹ í˜•: íŒì—… ìœ ì§€)
window.addCounselLog = async () => {
    const text = document.getElementById('newCounsel').value;
    if(!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    
    try {
        await updateDoc(doc(db, "students", currentStudentId), {
            counselLog: arrayUnion({ date: new Date().toLocaleDateString(), text: text })
        });
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById('newCounsel').value = "";
    } catch(e) { 
        alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); 
    }
};


// [ìˆ˜ì •] ì›í„°ì¹˜ ì „ì†¡ (ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ + ë²„íŠ¼ ì˜êµ¬ ë¹„í™œì„±í™”)
window.quickAttendance = async (id, type, btn) => {
    // ì´ë¯¸ ë¹„í™œì„±í™”ë©´ ì¤‘ë‹¨
    if(btn.disabled) return;
    
    const s = allStudents.find(st => st.id === id);
    if(!s) return;

    // 1. [íš¨ê³¼] ì¹´ë“œ í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
    const card = document.getElementById(`card-${id}`);
    if(card) {
        card.classList.remove('card-anim-active'); // ë¦¬ì…‹
        void card.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ (ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰ìš©)
        card.classList.add('card-anim-active');
    }
    
    // 2. íš¨ê³¼ìŒ ë° ê½ƒê°€ë£¨
    playSuccessSound();
    if (type === 'in') {
        try { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#FFD700', '#F0E68C'] }); } catch(e) {}
        if(card) card.classList.add('arrived'); 
    }

    // 3. ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ëˆ„ë¥´ëŠ” ì¦‰ì‹œ ë¹„í™œì„±í™” & í…ìŠ¤íŠ¸ ë³€ê²½)
    const originalText = btn.innerText;
    btn.innerText = "ì „ì†¡ì¤‘..";
    btn.disabled = true; // [ì¤‘ìš”] ì¦‰ì‹œ ë¹„í™œì„±í™”

    try {
        const now = new Date();
        
        // ì‹œê°„ í¬ë§· (ì˜¤ì „/ì˜¤í›„)
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const period = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
        hours = hours % 12; 
        hours = hours ? hours : 12;
        const timeStr = `${period} ${hours}:${minutes}`;
        
        const msg = type === 'in' 
            ? `[ë¯¸ë˜ì—”ìˆ˜í•™] ${s.name} í•™ìƒì´ ${timeStr}ì— êµì‹¤ì— ë„ì°©í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤.`
            : `[ë¯¸ë˜ì—”ìˆ˜í•™] ${s.name} í•™ìƒì´ ${timeStr}ì— í•™ìŠµì„ ë§ˆì¹˜ê³  í•˜ì›í•©ë‹ˆë‹¤.`;

        // DB ì €ì¥ (ë“±ì›ì¸ ê²½ìš°)
        if (type === 'in') {
            await updateDoc(doc(db, "students", id), { attendanceLog: arrayUnion(now) });
        }

        // ë¬¸ì ë°œì†¡
        if (s.phone) {
            fetch(`${SMS_SERVER_BASE}/send-sms`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "x-api-key": SMS_CLIENT_KEY },
                body: JSON.stringify({ receiver: s.phone.replace(/[^0-9]/g, ''), msg })
            });
        }

        // [ì¤‘ìš”] ì™„ë£Œ í›„ì—ë„ ë²„íŠ¼ì„ ë‹¤ì‹œ í™œì„±í™”í•˜ì§€ ì•ŠìŒ (ë¹„í™œì„± ìœ ì§€)
        btn.innerText = "ì™„ë£Œ"; 
        // í•˜ì› ë²„íŠ¼ ë“± ë‹¤ë¥¸ ë²„íŠ¼ì„ ì‹¤ìˆ˜ë¡œ ëˆ„ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ 
        // 'ì „ì†¡ë¨' í…ìŠ¤íŠ¸ë¥¼ ìœ ì§€í•˜ê³  íšŒìƒ‰ ìƒíƒœ(CSSì˜ :disabled)ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

    } catch (e) {
        alert("ì˜¤ë¥˜: " + e.message);
        // ì˜¤ë¥˜ ì‹œì—ë§Œ ë‹¤ì‹œ ëˆ„ë¥¼ ìˆ˜ ìˆê²Œ ë³µêµ¬
        btn.disabled = false;
        btn.innerText = originalText;
    }
};// [ì¶”ê°€] íš¨ê³¼ìŒ í•¨ìˆ˜ (Web Audio API ì‚¬ìš© - ë³„ë„ íŒŒì¼ í•„ìš” ì—†ìŒ)
function playSuccessSound() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    
    // ë”© (ë¯¸)
    osc.frequency.setValueAtTime(659.25, ctx.currentTime); 
    // ë™ (ì†”)
    osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2); 
    
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    
    osc.start();
    osc.stop(ctx.currentTime + 0.5);
}

// [ì¶”ê°€] í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ ì§„ì…
window.startKioskMode = () => {
    if (confirm("ì¶œì„ë¶€ ëª¨ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. (í•´ì œí•˜ë ¤ë©´ ìš°ì¸¡ í•˜ë‹¨ì„ í´ë¦­í•˜ì„¸ìš”)")) {
        document.body.classList.add('kiosk-mode');
        // ì„ ìƒë‹˜ ëª¨ë“œ ì²´í¬ í•´ì œ ë° ìˆ¨ê¹€ ì²˜ë¦¬
        const chk = document.getElementById('adminToggle');
        if(chk) chk.checked = false;
        document.body.classList.remove('show-admin');
        
        filterList(); // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (í° ì¹´ë“œë¡œ ë³€ê²½ë¨)
    }
};

// [ì¶”ê°€] í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œ í•´ì œ
window.exitKioskMode = () => {
    if (!document.body.classList.contains('kiosk-mode')) return;
    
    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ê¸°ì¡´ ì„ ìƒë‹˜ ë¹„ë²ˆê³¼ ë™ì¼í•˜ê²Œ 1234 ì‚¬ìš© ì˜ˆì‹œ)
    const pw = prompt("ì¶œì„ë¶€ ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    if (pw === "1234") { 
        document.body.classList.remove('kiosk-mode');
        alert("ì„ ìƒë‹˜ ëª¨ë“œë¡œ ëŒì•„ì™”ìŠµë‹ˆë‹¤.");
        filterList(); // ë¦¬ìŠ¤íŠ¸ ì›ë˜ëŒ€ë¡œ
    } else if (pw !== null) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
};

// [ì¶”ê°€] ê²€ìƒ‰ì°½ ë™ê¸°í™”
window.syncSearch = (val) => {
    filterList();
};
    window.toggleKioskMode = () => {
        const next = !__kioskMode;
        if (next) {
            const ok = confirm("ì¶œì„ë¶€ ëª¨ë“œë¥¼ ì¼œë©´ 'ì›ìƒ ê´€ë¦¬(ì¶œì„)' í™”ë©´ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì¼¤ê¹Œìš”?");
            if (!ok) {
                const kioskChk = document.getElementById('kioskToggle');
                if (kioskChk) kioskChk.checked = false;
                return;
            }
        }
        applyKioskMode(next);
    };

    // í† ìŠ¤íŠ¸(í•˜ë‹¨ ì•Œë¦¼)
    function showToast(message, type='success', ms=1600) {
        const toast = document.getElementById('toast');
        const textEl = document.getElementById('toastText');
        if (!toast || !textEl) return;

        toast.classList.remove('show','error','warn');
        if (type === 'error') toast.classList.add('error');
        if (type === 'warn') toast.classList.add('warn');
        textEl.textContent = message;

        // reflow
        void toast.offsetWidth;
        toast.classList.add('show');
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(() => toast.classList.remove('show'), ms);
    }

    // í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œì—ì„œëŠ” ìƒì„¸ íŒì—…ì„ ì—´ì§€ ì•Šê²Œ
    const __openDetailByIdOriginal = window.openDetailById;
    window.openDetailById = (id) => {
        if (window.isKioskMode && window.isKioskMode()) return;
        return __openDetailByIdOriginal ? __openDetailByIdOriginal(id) : undefined;
    };

    // ìµœì´ˆ ë¡œë“œì‹œ ì ìš©
    window.addEventListener('load', () => applyKioskMode(__kioskMode));

</script>

    <div id="toast" class="toast" aria-live="polite" aria-atomic="true"><span class="dot"></span><span id="toastText"></span></div>
<div class="exit-trigger" onclick="exitKioskMode()"></div>
</body>
</html>
